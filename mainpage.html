<!DOCTYPE html>
<html>
<script>
    window.nodeRequire = require;
    delete window.process;
    delete window.require;
    delete window.exports;
    delete window.module;
</script>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>EasyType</title>
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">
    <link rel="stylesheet" href="bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="css/main.css">
</head>

<body>
    <div id="loginpage" class="login_wrap loginpage">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-4"></div>
                <div class="col-md-4">
                    <div class="login_container">
                        <div class="header_logo align_center">
                            <img src="images/easytype.svg">
                            <span>easytype</span>
                        </div>
                        <div class="login_form">
                            <!--  FORM START  -->
                            <label for="siteName">sitename</label>
                            <input id="siteName" type="text" class="login_input" placeholder="https://" autofocus
                                required>
                            <label for="userName">username</label>
                            <input id="userName" type="text" class="login_input" placeholder="username" required>
                            <label for="password">password</label>
                            <input id="password" type="password" class="login_input" placeholder="**********" required>
                            <label for="min">From</label>
                            <input id="min" type="text" class="login_input" pattern="^[0-9]*$" />
                            <label for="max">To</label>
                            <input id="max" type="text" class="login_input" pattern="^[0-9]*$" />
                            <label>extendedtoolkit path</label>
                            <div class="relativediv">
                                <label class="select_path_btn" for="toolkitpath">Browse</label>
                                <input id="toolkitpath" class="out_of_display">
                                <div class="login_input toolkitname">
                                    <span id="file-selected"></span>
                                </div>
                            </div>
                            <label class="inline_block">indesign version</label>
                            <div class="id_version">
                                <input type="radio" name="version" id="is_CS6" onchange="valueChanged1()" value="cs6">
                                <span>CS6</span>
                                <input type="radio" name="version" id="is_CC" onchange="valueChanged2()" value="cc">
                                <span>CC</span>
                            </div>
                            <button id="credsSave" class="large_button">SAVE CREDENTIALS &amp; LOGIN</button>
                            <!--  END  -->
                        </div>
                    </div>
                </div>
                <div class="col-md-4"></div>
            </div>
            <div class="row">
                <div class="col-md-7">
                </div>
                <div class="col-md-5">
                    <img class="footerimg positioning" src="images/pagemajik.svg">
                </div>
            </div>
        </div>
    </div>
    <div id="loadingpage" class="login_wrap loadingpage">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-2"></div>
                <div class="col-sm-8">
                    <div class="loading_wrap" style="margin-top: 148px;">
                        <div class="row">
                            <div class="col-sm-4"></div>
                            <div class="col-sm-4">
                                <div class="login_container">
                                    <div class="header_logo head1 align_center">
                                        <img src="images/easytype.svg">
                                        <span>easytype</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4"></div>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-pmload">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-2"></div>
            </div>
            <div class="row">
                <div class="col-sm-7">
                </div>
                <div class="col-sm-5">
                    <img class="footerimg" src="images/pagemajik.svg">
                </div>
            </div>
        </div>
    </div>
    <div id="contentpage" class="page_wrap contentpage">
        <div class="fixed_header">
            <img src="images/easytype.svg">
            <span>easytype</span>
            <button class="configure" onclick="configs();">Configure</button>
        </div>
        <div class="container-fluid" style="min-height:48px; margin-bottom: 15px;">
            <div class="row">
                <div class="col-sm-2"></div>
                <div class="col-sm-8">
                    <!--  ERROR BOX-->
                    <div class="errorbox" style="display: none;">
                        <p id="error">EXTENDEDTOOLKIT PATH INCORRECT OR NOT FOUND. REINITIALISE!
                            <a href="#">CLICK HERE</a>
                        </p>
                    </div>
                    <!--  END  -->
                </div>
                <div class="col-sm-2"></div>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-sm-4">
                    <div id="cblist" class="contentstable contentsleft">

                        <!--  SITE HEADING  -->
                        <div class="content_header">
                            <input class="hidden" type="checkbox" id="box-1">
                            <label for="box-1">AVAILABLE SITES</label>
                        </div>
                        <!--  END  -->
                        <!--  SITE NAME  -->
                        <!-- <div class="content_header content_list_left">
                            <input class="hidden" type="checkbox" id="box-2">
                            <label for="box-2">Backup Springer</label>
                        </div> -->
                        <!--  END  -->
                        <!-- <div class="content_header content_list_left">
                            <input class="hidden" type="checkbox" id="box-3">
                            <label for="box-3">FA Davis</label>
                        </div>
                        <div class="content_header content_list_left">
                            <input class="hidden" type="checkbox" id="box-4">
                            <label for="box-4">Guest</label>
                        </div>
                        <div class="content_header content_list_left">
                            <input class="hidden" type="checkbox" id="box-5">
                            <label for="box-5">KLI</label>
                        </div>
                        <div class="content_header content_list_left">
                            <input class="hidden" type="checkbox" id="box-6">
                            <label for="box-6">Lambda</label>
                        </div>
                        <div class="content_header content_list_left">
                            <input class="hidden" type="checkbox" id="box-7">
                            <label for="box-7">oddint Media</label>
                        </div> -->
                    </div>
                </div>
                <div class="col-sm-8">
                    <div class="contentstable contentsright">
                        <!--  PROCESS HEADING  -->
                        <div class="content_header">
                            <label>PROCESSES</label>
                        </div>
                        <!--  END  -->
                        <ul class="nav nav-pills">
                            <li class="active">
                                <a data-toggle="pill" href="#menu1" class="active show" style="border-left: none;">In
                                    Progress</a>
                            </li>
                            <!-- <li>
                                <a data-toggle="pill" href="#menu2" onclick="refreshcdata()">Completed</a>
                            </li>
                            <li>
                                <a data-toggle="pill" href="#menu3" onclick="refreshfdata()">Failed</a>
                            </li> -->
                        </ul>

                        <div class="tab-content">
                            <div id="menu1" class="tab-pane  active show">
                                <!--  IN-PROGRESS HEADING  -->
                                <!-- <div class="content_list_right">
                                    <span>Filename.extension</span>
                                </div> -->
                                <!--  END  -->
                                <!--  <div class="content_list_right">
                                    <span>thisisareallylongfilenamethatihaveaddedtoshowhowthelinebreakswork.xhtml</span>
                                </div> -->
                            </div>
                            <!--    <div id="menu2" class="tab-pane">
                                <div id="completed-table"></div> -->
                            <!--  COMPLETED HEADING  -->
                            <!-- <div class="content_list_right">
                                    <span>Filename.extension</span>
                                </div> -->
                            <!--  END  -->
                            <!-- <div class="content_list_right">
                                    <span>Sample.extension</span>
                                </div> -->
                            <!--  </div>
                            <div id="menu3" class="tab-pane">
                                <div id="failed-table"></div> -->
                            <!--  FAILED HEADING  -->
                            <!-- <div class="content_list_right">
                                    <span>icantthinkofafilename.extension</span>
                                </div> -->
                            <!--  END -->
                            <!-- <div class="content_list_right">
                                    <span>omglolololol.xhtml</span>
                                </div> -->
                            <!--  </div> -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="row" style="margin-top: 15px;">
                <div class="col-sm-12">
                    <!--  FOOTER BUTTONS  -->
                    <button class="footer_btn" onclick="buildSitesSelected()">SYNC SITES</button>
                    <button id="startbutton" class="footer_btn pull-right start_btn" onclick="StartProcess()">START</button>
                    <button class="footer_btn pull-right" onclick="winReload()">RESTART APP</button>
                    <!--  END  -->
                </div>
            </div>

        </div>
    </div>
    <script src="JS/jquery-3.2.1.js"></script>
    <script src="JS/jquery-ui.js"></script>
    <script src="bootstrap/js/bootstrap.js"></script>
    <!--   <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.5.2/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.5.2/js/tabulator.min.js"></script>
     -->
    <script>
        var app = nodeRequire('electron').remote;
        const {
            webFrame
        } = nodeRequire('electron')
        const BrowserWindow = app.BrowserWindow;
        var request = nodeRequire('request');
        var _ = nodeRequire('lodash');
        //  var copydir = nodeRequire('copy-dir');
        var rp = nodeRequire('request-promise');
        const os = nodeRequire('os');
        var watcher = nodeRequire('./dummy.js')
        var Promise = nodeRequire('promise');
        var fse = nodeRequire("fs-extra");
        //var sfs = nodeRequire('@mh-cbon/sudo-fs');
        var http = nodeRequire('http');
        var miscellaneousFolderID = "";
        var prepend = nodeRequire('prepend-file');
        var cmd = nodeRequire('node-cmd');
        var chokidar = nodeRequire('chokidar');
        var webdav = nodeRequire('./windows.js')
        var exec = nodeRequire('child_process').exec
        var spawn = nodeRequire('child_process').spawn
        const osName = nodeRequire('os-name');
        var URL = nodeRequire('url-parse');
        var osascript = nodeRequire('node-osascript');
        const fixPath = nodeRequire('fix-path')();
        var copy = nodeRequire('recursive-copy');
        const util = nodeRequire('util');
        nodeRequire('util.promisify').shim();
        const setTimeoutPromise = util.promisify(setTimeout);
        var email = nodeRequire("emailjs");
        var output = localStorage.getItem('output');
        var fs = nodeRequire("fs");
        const fileExists = nodeRequire('file-exists');
        var winston = nodeRequire('winston');
        var config = nodeRequire('./config.json')





        var express = nodeRequire("express");
        var bodyParser = nodeRequire("body-parser");
        var routes = nodeRequire("./routes/routes.js");
        var exp = express();

        exp.use(bodyParser.json());
        exp.use(bodyParser.urlencoded({
            extended: true
        }));

        routes(exp);


        var server = CreateServer();


        let stack = [];

        watcher.watch();

        $(".loginpage").css("display", "none");
        $(".contentpage").css("display", "block");



        function StartProcess() {
            //Check the stack for pending FileEntryID's
            CheckStack();
        }

        function CheckStack() {
            var timeout;
            if(config.hasOwnProperty('Easytpe_Queue_Refresh_Interval')){
                timeout = config['Easytpe_Queue_Refresh_Interval'] * 1000
            } else {
                timeout = 10000
            }
            //console.log(timeout)
            if (!Array.isArray(stack) || !stack.length) {
                // array does not exist, is not an array, or is empty

                console.log("Array empty")
            } else {
                console.log("Now we're talkin'")
                //Check the number of main instances 
                //await getSiteCreds(SITE_URL)
                //Make sure same fileEntry doesn'r exist


                console.log(main(stack.shift()));

                // main(36493512);
                // main(36493590);
                // main(38519096);
                // main(36400200);
                // main(36338372);
                // main(36864358);
                // main(36864655);
                // main(36864728);
            }
            setTimeout(CheckStack, timeout)
        }

        function getSiteCreds() {

        }

        async function main(fileEntryId) {
            var temp = fileEntryId.split("***")
            var fileEntryId = temp[0];
            var logger;
            //fileEntryId = 36493512;
            var process;
            var filePath;
            var filepathbroken;
            var stage;
            var filePath;
            var currentProcess;
            var filePresetId;
            var statusfileuserId;
            var filename;
            var fileFolderId;
            var fileRepFolderId;
            var fileExtension;
            var fileMimeType;
            var fileDescription;
            var fileTreePath;
            var companyId;
            var fileuserId;
            var notifyuserId;
            var pagenum;
            var ReviewId;
            var SupportId;
            var yin = false;
            var yang = false;
            var pagenum = null;
            var scriptWriteComplete = false;
            var indesignScriptInpPath;
            var downloadPath;
            var FontsId;
            var BookLevelAdobeScriptId;
            var LibraryId;
            var PresetId;
            var SiteLevelAdobeScriptId;
            var ClientLevelAdobeScriptId;
            var ClientLevelPagemajikScriptId;
            var InstructionId;
            var SiteLevelPagemajikScriptId;
            var BookLevelPagemajikScriptId;
            var MiscellaneousId;
            var artFolderId;
            var commonArtFolderId;
            var BookMapId;
            var contents;
            var JsxContents;
            var ezTypeUserId;
            var supportPath;
            var SITE_URL = temp[1]


            if(config.hasOwnProperty(SITE_URL)){
                console.log("Yoo.. U got the rep")
                console.log(config)
                DEFAULT_USER = config[SITE_URL][0]
                DEFAULT_PASS = config[SITE_URL][1]
            } else {
                console.log("Not supposed to work here")
                return
            }


            // var DEFAULT_USER = "process"
            // var DEFAULT_PASS = "1234"






            console.log("Gotcha!!! popping from stack")
            console.log(stack)

            await fetchDetailsFromFileEntryId(fileEntryId).then(async function (result) {
                //http://developer.pagemajik.online/api/jsonws/Dazzle-portlet.pagemajik/get-all-file-assets/file-entry-id/39954210

                //get All Folder ID's
                // console.log(result)
                artFolderId = result.Art;
                //fileEntryId = result.fileEntryId;
                BookLevelAdobeScriptId = result.BookLevelAdobeScript;
                BookLevelPagemajikScriptId = result.BookLevelPagemajikScript;
                BookMapId = result.BookMap;
                ClientLevelAdobeScriptId = result.ClientLevelAdobeScript;
                ClientLevelPagemajikScriptId = result.ClientLevelPagemajikScript;
                commonArtFolderId = result.CommonArt;
                FontsId = result.Fonts;
                InstructionId = result.Instruction;
                LibraryId = result.Library;
                PresetId = result.Preset;
                ReviewId = result.Review;
                SiteLevelAdobeScriptId = result.SiteLevelAdobeScript;
                SiteLevelPagemajikScriptId = result.SiteLevelPagemajikScript;
                SupportId = result.Support;
                companyId = result.companyId;
                fileFolderId = result.folderId;
                fileRepFolderId = result.groupId;
                fileTreePath = result.filePath;
                process = result.process
                statusfileuserId = result.userId;
                stage = result.field5;
                filename = result.fileName;
                filePresetId = result.presetFileId;
                supportPath = PAGEMAJIK_DOWNLOAD_PATH + fileRepFolderId +
                    "/" +
                    fileFolderId + "/";

                await getUserIdByScreenName(companyId, DEFAULT_USER).then(function (
                    result) {
                    ezTypeUserId = result;
                   // console.log("Yooooooooooooo" +ezTypeUserId)
                });
                
               

                logger = winston.createLogger({
                    level: 'info',
                    format: winston.format.json(),
                    transports: [
                        //
                        // - Write to all logs with level `info` and below to `combined.log` 
                        // - Write all logs error (and below) to `error.log`.
                        //
                        new winston.transports.Stream({
                            stream: fs.createWriteStream(PAGEMAJIK_DOWNLOAD_PATH + "/" +
                                fileEntryId + '_error.log', {
                                    flags: 'a'
                                }),
                            level: 'error'
                        }),
                        new winston.transports.Stream({
                            stream: fs.createWriteStream(PAGEMAJIK_DOWNLOAD_PATH + "/" +
                                fileEntryId + '.log', {
                                    flags: 'a'
                                }),
                            level: 'info'
                        })
                    ]
                });

                logger.info("I am " + fileEntryId)






                indesignScriptInpPath = PAGEMAJIK_DOWNLOAD_PATH +
                    fileRepFolderId +
                    "/" +
                    fileFolderId + "/" + filename;
                downloadPath = PAGEMAJIK_DOWNLOAD_PATH +
                    fileRepFolderId +
                    "/" +
                    fileFolderId;
                fse.ensureDirSync(downloadPath);
                fse.emptyDir(downloadPath);
            })

            getBookmapPageNumber(BookMapId, filename).then(
                function (
                    result) {
                    console.log("PageNum is " + JSON.stringify(
                        result));
                    if (JSON.stringify(result) == "{}") {
                        //pagenum = 10
                        pagenum = null;
                    } else {
                        pagenum = JSON.stringify(result)
                    }

                    try {
                        JsxContents = writeJStoIndesignScriptJSX();
                    } catch (error) {
                        console.log(error)
                    }


                    yin = true


                })

            cancel_checkout_download(fileEntryId,
                fileRepFolderId)

            scriptsPath = os.homedir() + "/" +
                "Documents/Adobe Scripts/" +
                fileFolderId + "/";


            await updatedContentsForRsync();

            var completedFN = filename.replace(/\.[^/.]+$/,
                "_Completed.txt")
            var bookmapFN = filename.replace(/\.[^/.]+$/,
                "_bookmap.txt")
            var idmlfilename = filename.replace(/\.[^/.]+$/,
                ".idml")
            var inddname = filename.replace(/\.[^/.]+$/,
                ".indd")
            var pdffilename = filename.replace(/\.[^/.]+$/,
                ".pdf")
            var supportPath2 = supportPath.replace(/\//g,
                '\\')
            supportPath2 = supportPath2.replace(/\/\//g,
                '\\')

            if (process.match("Auto Correction") || process
                .match(
                    "First Proof")) {

                try {
                    await generateProof();
                } catch (error) {
                    console.log("Error Generate Proof" +
                        error)
                    sendmail("Generate Proof Failed ",
                        "Generate Proof failed for file " +
                        filePath + " with error " +
                        error)
                    return
                }
                //  generateProof();
                //runIndesignScript(scriptsPath + "PDF_Generator.jsx", scriptsPath);


            }

            if (process.match("Word to IDML")) {

                try {
                    await generateIndesign();
                } catch (error) {
                    console.log("Error Generate Indesign" +
                        error)
                    sendmail("Generate Indesign Failed  ",
                        "Generate Indesign failed for file " +
                        filePath + " with error " +
                        error)
                    return
                }

            }











            async function generateIndesign() {

                {
                    display = "generate Indesign";
                }

                var serverPath = await getServerPathSync(contents,
                    fileRepFolderId);
                var removepath = serverPath;

                var patt = /([\s\W])/g;
                serverPath = serverPath.replace(patt, '\\$1');


                try {
                    yang = await rsyncFetchwithretry(serverPath,
                        supportPath, "", "")
                } catch (error) {
                    console.log("Rsync finally failed")
                    sendmail("Rsync Failed ", "Rsync Failed for file " + idmlfilename + " in the site " +
                        SITE_URL + "with Error " + error)
                }

                try {
                    removefolderpath(removepath);

                } catch (error) {
                    logger.error("Unable to remove folder path")
                }

                var scriptName = "AutoPagination_Processor_Caller.jsx"


                var data = fs.readFileSync(scriptsPath +
                    scriptName).toString().split(
                    "\n");
                data.splice(0, 0,
                    JsxContents);
                var text = data.join("\n");

                fs.writeFileSync(scriptsPath +
                    scriptName, text, {},
                    function (err, data) {
                        logger.error(err)
                    });

                fontsFolderPath = supportPath + "Document fonts/"

                await fs.readdirSync(fontsFolderPath).forEach(file => {
                    logger.info(file);
                    if (file.match(".zip")) {

                        osascript.execute(
                            'tell application "Finder" to open POSIX file \"' +
                            fontsFolderPath + "/" + file + '\"',
                            function (err, result, raw) {
                                if (err) return logger.info(
                                    err)
                                logger.info(result, raw)
                            });

                    }

                })

                finalRunIndesign(yin, yang);

                function finalRunIndesign(yin, yang) {
                    if (yin == true && yang == true) {
                        console.log("Done")
                        runIndesignScript(scriptsPath, "AUTO")
                    } else {
                        setTimeout(function () {
                            finalRunIndesign(yin, yang)
                        }, 10000)
                    }


                }


            }

            async function generateProof() {
                if (process.match("Auto Correction")) {
                    display = "generate Revises";
                } else {
                    display = "generate Proof"
                }

                var serverPath = await getServerPathSync(contents,
                    fileRepFolderId);

                var removepath = serverPath;

                var patt = /([\s\W])/g;
                serverPath = serverPath.replace(patt, '\\$1');


                var scriptName;

                if (process.match("Auto Correction") || process
                    .match(
                        "First Proof")) {
                    scriptName = "PDF_Generator.jsx"
                } else {
                    scriptName = "AutoPagination_Processor_Caller.jsx"
                }



                try {
                    retry = 0
                    yang = await rsyncFetchwithretry(serverPath,
                        supportPath, "", "")
                } catch (error) {
                    console.log("Rsync finally failed")
                    sendmail("Rsync failed ", "Rsync Failed for file " + idmlfilename + " in the site " +
                        SITE_URL)
                }
                try {
                    removefolderpath(removepath);
                } catch (error) {
                    logger.error("Unable to remove folder path " + error)
                }

                var data = fs.readFileSync(scriptsPath +
                    scriptName).toString().split(
                    "\n");
                data.splice(0, 0,
                    JsxContents);
                var text = data.join("\n");

                fs.writeFileSync(scriptsPath +
                    scriptName, text, {},
                    function (err, data) {
                        logger.error(err)
                    });

                fontsFolderPath = supportPath + "Document fonts/"

                fs.readdirSync(fontsFolderPath).forEach(file => {
                    logger.info(file);
                    if (file.match(".zip")) {

                        osascript.execute(
                            'tell application "Finder" to open POSIX file \"' +
                            fontsFolderPath + "/" + file + '\"',
                            function (err, result, raw) {
                                if (err) return logger.info(
                                    err)
                                logger.info(result, raw)
                            });

                    }

                })

                finalRunIndesign(yin, yang);

                function finalRunIndesign(yin, yang) {
                    if (yin == true && yang == true) {
                        console.log("Done")
                        runIndesignScript(scriptsPath, "PDF")
                    } else {
                        setTimeout(function () {
                            finalRunIndesign(yin, yang)
                        }, 10000)
                    }


                }

            }




            // ------> END <-------- \\

            function runIndesignScript(scriptsPath, type) {


                var processtype = null;
                if (type == "AUTO") {
                    processtype = "AutoPagination_Processor_Caller.jsx"
                } else {
                    processtype = "PDF_Generator.jsx"
                }


                var tmpscript = scriptsPath.replace(" ", "%20")
                var tmpIND =
                    "http://localhost:8080/com.adobe.clover.application/api/idsqueue/EnqueueJob?scriptName=" +
                    tmpscript + processtype + "&jobName=" + fileEntryId +
                    "&priority=.5&queueName=Default&maximumRetryCount=3"
                logger.info(JSON.stringify(tmpIND))
                var optionsIND = {
                    method: 'GET',
                    uri: tmpIND,
                    timeout: 360000,
                    resolveWithFullResponse: true
                };
                // logger.info(fileEntryID)

                // Return new promise 

                return new Promise(function (resolve, reject) {
                    // Do async job
                    rp(optionsIND)
                        .then(function (response) {
                            // POST succeeded...
                            logger.info(response.body)
                            var currentIND = response
                            // logger.info(currentGPF.title)

                            return resolve(currentIND);

                        })
                        .catch(function (err) {
                            // POST failed...
                            logger.error(err);
                            //  gotonextfile();
                            return reject(err);

                        });
                })
            }

            function getBookmapPageNumber(fileEntryId, title) {
                var patt1 = /\.[0-9a-z]+$/i;
                var twe = title.replace(patt1, "")
                var tmpGBM = SITE_URL +
                    "/api/jsonws/Dazzle-portlet.pagemajik/get-book-map-json/file-entry-id/" + fileEntryId +
                    "/chapter-title/" + twe
                console.log(JSON.stringify(tmpGBM))
                var optionsGBM = {
                    method: 'GET',
                    uri: tmpGBM,
                    auth: {
                        'user': DEFAULT_USER,
                        'pass': DEFAULT_PASS
                    },
                    timeout: 120000,
                    resolveWithFullResponse: true
                };

                //  console.log(fileEntryID)

                // Return new promise 

                return new Promise(function (resolve, reject) {
                    // Do async job
                    rp(optionsGBM)
                        .then(function (response) {
                            // POST succeeded...
                            //   console.log(response)
                            console.log(JSON.parse(response.body))
                            var currentGBM = JSON.parse(response.body)
                            return resolve(currentGBM);

                        })
                        .catch(function (err) {
                            // POST failed...
                            console.log(err)
                          //  gotonextfile();
                            //  break;
                            // cancel_checkout_download(fileEntryID, fileRepFolderId)
                            return reject(err);
                        });
                })

            }

            function fetchDetailsFromFileEntryId(fileEntryId) {
                //http://developer.pagemajik.online/api/jsonws/Dazzle-portlet.pagemajik/get-all-file-assets/file-entry-id/39954210
                var tmpSDFF = SITE_URL + "/api/jsonws/Dazzle-portlet.pagemajik/get-all-file-assets/file-entry-id/" +
                    fileEntryId
                console.log(JSON.stringify(tmpSDFF))
                var optionsSDFF = {
                    method: 'GET',
                    uri: tmpSDFF,
                    auth: {
                        'user': DEFAULT_USER,
                        'pass': DEFAULT_PASS
                    },
                    timeout: 600000,
                    resolveWithFullResponse: true
                };
                //  logger.info(fileEntryID)

                // Return new promise 

                return new Promise(function (resolve, reject) {
                    // Do async job
                    rp(optionsSDFF)
                        .then(function (response) {
                            // POST succeeded...
                            console.log(JSON.parse(response.body))
                            var currentSDFF = JSON.parse(response.body)
                            return resolve(currentSDFF);

                        })
                        .catch(function (err) {
                            // POST failed...
                            console.log(err)
                            // gotonextfile();
                            // cancel_checkout_download(fileEntryID, fileRepFolderId)
                            return reject(err);
                        });
                })



            }




            function getPresetFilename(id) {
                var tmpGPF = SITE_URL + "/api/jsonws/dlapp/get-file-entry/file-entry-id/" + id;
                logger.info(JSON.stringify(tmpGPF))
                var optionsGPF = {
                    method: 'GET',
                    uri: tmpGPF,
                    auth: {
                        'user': DEFAULT_USER,
                        'pass': DEFAULT_PASS
                    },
                    timeout: 240000,
                    resolveWithFullResponse: true
                };
                // logger.info(fileEntryID)

                // Return new promise 

                return new Promise(function (resolve, reject) {
                    // Do async job
                    rp(optionsGPF)
                        .then(function (response) {
                            // POST succeeded...
                            //    logger.info(JSON.parse(response.body))
                            var currentGPF = JSON.parse(response.body)
                            // logger.info(currentGPF.title)

                            return resolve(currentGPF.title);

                        })
                        .catch(function (err) {
                            // POST failed...
                            logger.info(err);
                            //  gotonextfile();
                            return reject(err);

                        });
                })
            }


            function getUserIdByScreenName(companyID, userScreenName) {
                var tmpGUID = SITE_URL +
                    "/api/jsonws/user/get-user-id-by-screen-name/company-id/" + companyID + "/screen-name/" +
                    userScreenName;
                console.log(JSON.stringify(tmpGUID))
                var optionsGUID = {
                    method: 'GET',
                    uri: tmpGUID,
                    auth: {
                        'user': DEFAULT_USER,
                        'pass': DEFAULT_PASS
                    },
                    timeout: 120000,
                    resolveWithFullResponse: true
                };
                //  logger.info(fileEntryID)

                // Return new promise 

                return new Promise(function (resolve, reject) {
                    // Do async job
                    rp(optionsGUID)
                        .then(function (response) {
                            // POST succeeded...
                            console.log(response)
                            console.log(JSON.parse(response.body))
                            var currentGSP = JSON.parse(response.body)
                            return resolve(currentGSP);

                        })
                        .catch(function (err) {
                            // POST failed...
                            console.log(err)
                            // gotonextfile();
                            // cancel_checkout_download(fileEntryID, fileRepFolderId)
                            return reject(err);
                        });
                })
            }



            function updatedContentsForRsync() {

                return new Promise(async function (resolve, reject) {
                    contents = "%5B";
                    contents = contents + artFolderId + "%2C" +
                        fileFolderId
                    if (commonArtFolderId != 0) {
                        //contents.push(commonArtFolderId);
                        contents = contents + "%2C" +
                            commonArtFolderId;
                    }

                    if (PresetId != 0) {
                        //contents.push(commonArtFolderId);
                        contents = contents + "%2C" + PresetId;
                        presetFileName = await getPresetFilename(
                            filePresetId);
                        logger.info(presetFileName)
                    }
                    if (SiteLevelAdobeScriptId != 0) {
                        // contents.push(SiteLevelAdobeScriptID);
                        contents = contents + "%2C" + SiteLevelAdobeScriptId;
                    }

                    if (SiteLevelPagemajikScriptId != 0) {
                        // contents.push(SiteLevelPagemajikScriptID);
                        contents = contents + "%2C" +
                            SiteLevelPagemajikScriptId;
                        //unzip(os.homedir() + "/PageMajik/SLPM.zip", scriptsPath);
                    }

                    if (FontsId != 0) {
                        // contents.push(FontsID)
                        contents = contents + "%2C" + FontsId
                    }



                    if (ClientLevelAdobeScriptId != 0) {
                        // contents.push(ClientLevelAdobeScriptID);
                        contents = contents + "%2C" + ClientLevelAdobeScriptId
                    }

                    if (ClientLevelPagemajikScriptId != 0) {
                        //contents.push(ClientLevelPagemajikScriptID);
                        contents = contents + "%2C" +
                            ClientLevelPagemajikScriptId;
                    }



                    if (BookLevelAdobeScriptId != 0) {
                        //contents.push(BookLevelAdobeScriptID)
                        contents = contents + "%2C" + BookLevelAdobeScriptId
                    }

                    if (BookLevelPagemajikScriptId != 0) {
                        //contents.push(BookLevelPagemajikScriptID)
                        contents = contents + "%2C" +
                            BookLevelPagemajikScriptId;
                    }

                    if (InstructionId != 0) {
                        //contents.push(InstructionID);
                        contents = contents + "%2C" + InstructionId

                        //  unzip(os.homedir() + "/PageMajik/InstructionID.zip", supportPath +"/Instruction/");
                    }

                    if (process.match("Word to IDML")) {
                        if (LibraryId != 0) {
                            contents = contents + "%2C" + LibraryId
                        }
                    }
                    contents = contents + "%5D"
                    return resolve();
                })

            }

            function removefolderpath(filepath) {
                logger.info(filepath)
                var tmpRFP = SITE_URL +
                    "/api/jsonws/RSync-Portlet-portlet.rsync/remove-folder/"
                logger.info(JSON.stringify(tmpRFP))
                var optionsRFP = {
                    method: 'POST',
                    uri: tmpRFP,
                    auth: {
                        'user': DEFAULT_USER,
                        'pass': DEFAULT_PASS
                    },
                    timeout: 120000,
                    formData: {
                        path: filepath
                    }
                };
                //  logger.info(fileEntryID)

                // Return new promise 

                return new Promise(function (resolve, reject) {
                    // Do async job
                    rp(optionsRFP)
                        .then(function (response) {
                            // POST succeeded...
                            //   logger.info(response)
                            logger.info(JSON.parse(response))
                            var currentRFP = JSON.parse(response)
                            return resolve(currentRFP);

                        })
                        .catch(function (err) {
                            // POST failed...
                            logger.info(err)
                            gotonextfile();
                            //   break;
                            // cancel_checkout_download(fileEntryID, fileRepFolderId)
                            return reject(err);
                        });
                })
            }

            function cancel_checkout_download(fileEntryID, fileRepFolderId) {
                var tmpCCD = SITE_URL + "/api/jsonws/Dazzle-portlet.pagemajik/universal-service/file-entry-id/" +
                    fileEntryID + "/group-id/" + fileRepFolderId +
                    "/status/In%20Progress/option/1";
                logger.info(JSON.stringify(tmpCCD))
                var optionsCCD = {
                    method: 'POST',
                    uri: tmpCCD,
                    auth: {
                        'user': DEFAULT_USER,
                        'pass': DEFAULT_PASS
                    },
                    timeout: 240000,
                    resolveWithFullResponse: true
                };
                //  logger.info(fileEntryID)

                // Return new promise 

                return new Promise(function (resolve, reject) {
                    // Do async job
                    rp(optionsCCD)
                        .then(function (response) {
                            // POST succeeded...
                            //   logger.info(JSON.parse(response.body))
                            var currentCCD = JSON.parse(response.body)
                            return resolve(currentCCD);

                        })
                        .catch(function (err) {
                            // POST failed...
                            logger.info(err)
                            // cancel_checkout_download(fileEntryID, fileRepFolderId)
                            sendNotification(companyID, fileRepFolderId, ezTypeUserID,
                                "",
                                "", ezTypeUserID, filename + " " + display +
                                "Unexpected Error. Kindly run the file again ", false,
                                statusfileuserID);
                            // gotonextfile(); // need to work on it - File checked in by me, but i don't have download path ?? coz i missed my window, now no file
                            return reject(err);
                        });
                })
            }

            async function getServerPathSync(contents, fileRepFolderId) {
                var tmpGSP = SITE_URL + "/api/jsonws/RSync-Portlet-portlet.rsync/get-folder-files/folder-ids/" +
                    contents +
                    "/grp-id/" + fileRepFolderId;
                logger.info(JSON.stringify(tmpGSP))
                var optionsGSP = {
                    method: 'GET',
                    uri: tmpGSP,
                    auth: {
                        'user': DEFAULT_USER,
                        'pass': DEFAULT_PASS
                    },
                    timeout: 600000,
                    resolveWithFullResponse: true
                };
                //  logger.info(fileEntryID)

                // Return new promise 

                return new Promise(function (resolve, reject) {
                    // Do async job
                    rp(optionsGSP)
                        .then(function (response) {
                            // POST succeeded...
                            logger.info(JSON.parse(response.body))
                            var currentGSP = JSON.parse(response.body)
                            return resolve(currentGSP);

                        })
                        .catch(function (err) {
                            // POST failed...
                            logger.info(err)
                            gotonextfile();
                            // cancel_checkout_download(fileEntryID, fileRepFolderId)
                            return reject(err);
                        });
                })

            }

            function delay(t, val) {
                return new Promise(function (resolve) {
                    setTimeout(function () {
                        resolve(val);
                    }, t);
                });
            }

            async function rsyncFetchwithretry(serverPath,
                supportPath, heimdall, dumb) {
                return new Promise(async function (resolve, reject) {
                    // Do async job
                    try {
                        await delay(3000, "try")
                        await rsyncFetch(serverPath,
                            supportPath, "", "")
                        return resolve(true);
                    } catch (error) {
                        console.log(error)
                        console.log("rsync Failed.. gonna retry 1")
                        try {
                            await delay(3000, "retry1")
                            await rsyncFetch(serverPath,
                                supportPath, "", "")
                            return resolve(true);
                        } catch (error) {
                            console.log("retry 1 failed")
                            console.log("rsync Failed.. gonna retry 2")
                            try {
                                await delay(3000, "retry2")
                                rsyncFetch(serverPath,
                                    supportPath, "", "")
                                return resolve(true);
                            } catch (error) {
                                console.log("retry 2 failed")
                                console.log("rsync Failed.. gonna retry 3")
                                try {
                                    await delay(3000, "retry3")
                                    await rsyncFetch(serverPath,
                                        supportPath, "", "")
                                    return resolve(true);
                                } catch (error) {
                                    console.log("retry 3 failed")
                                    console.log("I have failed enough")
                                    return reject();
                                    //   startpen();
                                    //  return
                                }
                            }
                        }
                    }
                })
            }

            function rsyncFetch(filepath, destination, key, instancelogin) {
                var filepath = filepath + "/"
                var destination = destination
                var key = key
                var hostname = instancelogin
                var okay = true;
                return new Promise(function (resolve, reject) {

                    //	var OS = OS

                    // process1.env.PATH = "C:/windows/system32";
                    // console.log(process1.env.PATH)
                    // console.log(supportPath)
                    /*  if (!fs.existsSync(os.homedir() + "/supportPath")) {
                         fs.mkdirSync(os.homedir() + "/supportPath");
                     } */

                    //Example

                    //    var key = "c:/Work/Rsync/Rsync/uploadingserver.pem"

                    //online ubuntu@ec2-34-232-189-147.compute-1.amazonaws.com

                    // net ubuntu@ec2-34-230-193-170.compute-1.amazonaws.com:

                    //  var hostname = "ubuntu@ec2-54-237-212-163.compute-1.amazonaws.com"

                    //test server info ubuntu@ec2-35-169-174-159.compute-1.amazonaws.com:

                    //  var filepath = "/opt/tmp"

                    //   var destination = "c:/Work/Rsync/Rsync/"
                    var patt = /([\s])/g;

                    if (SITE_URL.match(".online")) {
                        hostname = "ubuntu@ec2-34-232-189-147.compute-1.amazonaws.com:";
                        key = os.homedir() + "/pagemajik-com-online.pem"
                    }
                    if (SITE_URL.match(".net")) {
                        hostname = "ubuntu@ec2-34-230-193-170.compute-1.amazonaws.com:";
                        key = os.homedir() + "/pagemajik-com-net.pem"
                    }
                    if (SITE_URL.match(".info")) {
                        hostname = "ubuntu@ec2-35-169-174-159.compute-1.amazonaws.com:";
                        key = os.homedir() + "/pagemajik-com-info.pem"
                    }
                    if (SITE_URL.match("org")) {
                        hostname = "ubuntu@ec2-34-237-132-223.compute-1.amazonaws.com:";
                        key = os.homedir() + "/pagemajik-com-org.pem"
                    }
                    if (SITE_URL.match("10.1.1.41")) {
                        hostname = "liferayapp@10.1.1.41:";
                        key = os.homedir() + "/pagemajik-com-41.pem"
                    }
                    //    key = key.replace(patt, '\\$1');

                    logger.info(os.homedir() + destination)
                    var dataf = [];

                    //sample command
                    //child = exec("rsync -Pav -e \"ssh -i "+key+"\" "+hostname+":"+filepath+ " "+destination)
                    //rsync -avre "ssh -i uploadingserver.pem" ubuntu@ec2-54-80-249-39.compute-1.amazonaws.com:/opt/tmp /Users/rd/Desktop/Subash/Temp/

                    var child = exec("rsync --inplace -avrue \"ssh -o StrictHostKeyChecking=no -i \'" + key +
                        "\'\" " + "\"" +
                        hostname +
                        "" + filepath +
                        "\"" +
                        " .", {
                            cwd: destination
                        });
                    child.stdout.on('data', function (data) {
                        //pendingfiles();
                        //console.log(data)
                        // dataf.push(data);
                    })

                    child.stderr.on('data', async function (data) {
                        //pendingfiles();
                        logger.info(data)

                        if (data.match("spawn")) {
                            okay = false
                            return reject();
                        } else if (data.match("No such file") || (data.match("some files"))) {
                            okay = false
                            return reject();
                        } else {

                        }


                    })
                    child.on("close", async function () {

                        // Do async job

                        var container = $('#menu1');


                        logger.info(scriptsPath)


                        if (okay) {
                            $(container).append("<div class='content_list_right'>" +
                                "<span>" + "Rsync process completed ." + "</span>" +
                                "</div>");
                            fse.ensureDirSync(destination + 'Fonts');
                            fse.ensureDirSync(destination + 'Art');

                            try {
                                fse.move(destination + "Fonts/", destination + "Document fonts", {
                                    overwrite: true
                                }, err => {
                                    if (err) return logger.info(err)

                                    logger.info('success!')
                                })
                            } catch (error) {
                                return reject(err);
                            }


                            try {
                                fse.move(destination + "Art/", destination + "Links", {
                                    overwrite: true
                                }, err => {
                                    if (err) return logger.info(err)

                                    logger.info('success!')
                                })
                            } catch (error) {
                                return reject(err);
                            }


                            fse.ensureDirSync(destination + "Print Preset");
                            fs.readdirSync(destination + "Print Preset").forEach(file => {
                                logger.info(file);
                                if (file !== presetFileName) {
                                    fs.unlink(destination + "Print Preset/" + file)
                                }

                            })

                            //   copydir.sync(destination + "PageMajik", "/Documents/Adobe\ Scripts/");

                            var i = 1
                            //  logger.info("Copying scripts one")
                            //    await  copydir(destination + "PageMajik/*", os.homedir()+"/Documents/Adobe\ Scripts/")
                            //   logger.info("copying scripts two")
                            //      await  copydir(destination + "Adobe\ Scripts/*", os.homedir()+"/Documents/Adobe\ Scripts/")

                            // copydir.sync(destination + "PageMajik", "/Documents/Adobe\ Scripts/");

                            fse.copy(destination + "Indesign",
                                destination,
                                function (err) {
                                    if (err) {
                                        logger.warn(err);
                                        return reject(err);
                                    } else {
                                        logger.info("success!");
                                    }
                                });

                            fse.copy(destination + "PageMajik", os.homedir() +
                                "/Documents/Adobe Scripts/" +
                                fileFolderId,
                                function (err) {
                                    if (err) {
                                        logger.error(err);
                                        return reject(err);
                                    } else {
                                        logger.info("success!");
                                        fse.copy(destination + "Adobe Scripts", os.homedir() +
                                            "/Documents/Adobe Scripts/" + fileFolderId,
                                            function (err) {
                                                if (err) {
                                                    logger.error(err);
                                                    return reject(err);
                                                } else {
                                                    logger.info("success!");
                                                    return resolve("done");
                                                }
                                            });
                                    }
                                }); //copies directory, even if it has subdirectories or file

                            heimdall = true;
                        }

                    })

                })
            }

            function writeJStoIndesignScriptJSX() {
                logger.info("JSX script")
                var javascriptContent = '';
                javascriptContent = javascriptContent +
                    " var	statusfileuserID = \"" +
                    statusfileuserId + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var	ezTypeUserID = \"" +
                    ezTypeUserId + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var	siteURL = \"" +
                    SITE_URL + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var	inputFilePath = \"" +
                    indesignScriptInpPath + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var	scriptsFilePath = \"" +
                    scriptsPath + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var pagenum =" +
                    pagenum + "\n";
                javascriptContent = javascriptContent +
                    " var PageNumStyle = \"" +
                    "" + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var webDavAddress = \"" +
                    supportPath2 + "Links" + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var userName = \"" +
                    DEFAULT_USER + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var userCred = \"" +
                    DEFAULT_PASS + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var fileEntryID = \"" +
                    fileEntryId + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var process = \"" +
                    process + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var filename = \"" +
                    filename + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var fileFolderId = \"" +
                    fileFolderId + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var fileRepFolderId = \"" +
                    fileRepFolderId + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var fileExtension = \"" +
                    fileExtension + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var fileMimeType = \"" +
                    fileMimeType + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var fileDescription = \"" +
                    fileDescription + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var fileTreePath = \"" +
                    fileTreePath + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var filePath = \"" +
                    filePath + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var companyID = \"" +
                    companyId + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var fileuserID = \"" +
                    statusfileuserId + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var slugLineInfo = \"" +
                    stage + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var BookMapID = \"" +
                    BookMapId + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var ReviewID = \"" +
                    ReviewId + "\"" + "\n";
                javascriptContent = javascriptContent +
                    " var SupportID = \"" +
                    SupportId + "\"" + "\n";
                logger.info(javascriptContent);

                return javascriptContent

            }


        }









        var PAGEMAJIK_DOWNLOAD_PATH = os.homedir() + "/" + "PageMajik/";

        var server = email.server.connect({
            user: "support@pagemajik.com",
            password: "",
            host: "smtp.gmail.com",
            ssl: true
        });

        async function sendmail(subject, message) {
            // server.send({
            //     text: message,
            //     from: "support@pagemajik.com",
            //     to: "support@pagemajik.com",
            //     cc: "bhaskara@pagemajik.com,subashp@pagemajik.com",
            //     subject: subject
            // }, function (err, message) {
            //     console.log(err || message);
            // });
        }


        function popstack() {
            console.log(stack.shift())
            console.log(stack)
        }


        var updateStack = function (stackvalue) {
           // stack.push(stackvalue)
            stack.indexOf(stackvalue) === -1 ? stack.push(stackvalue) : console.log("This item already exists");
            console.log(stack)
        }

        async function CreateServer() {
            var server = await exp.listen(3000, async function () {
                console.log("app running on port.", server.address().port);
            });
            return server;
        }
    </script>
</body>

</html>