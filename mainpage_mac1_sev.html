<!DOCTYPE html>
<html>
<script>
    window.nodeRequire = require;
    delete window.process;
    delete window.require;
    delete window.exports;
    delete window.module;
</script>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>EasyType</title>
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">
    <link rel="stylesheet" href="bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="css/main.css">
</head>

<body>
    <div id="loginpage" class="login_wrap loginpage">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-4"></div>
                <div class="col-md-4">
                    <div class="login_container">
                        <div class="header_logo align_center">
                            <img src="images/easytype.svg">
                            <span>easytype</span>
                        </div>
                        <div class="login_form">
                            <!--  FORM START  -->
                            <label for="siteName">sitename</label>
                            <input id="siteName" type="text" class="login_input" placeholder="https://" autofocus required>
                            <label for="userName">username</label>
                            <input id="userName" type="text" class="login_input" placeholder="username" required>
                            <label for="password">password</label>
                            <input id="password" type="password" class="login_input" placeholder="**********" required>
                            <label for="min">From</label>
                            <input id="min" type="text" class="login_input" pattern="^[0-9]*$" />
                            <label for="max">To</label>
                            <input id="max" type="text" class="login_input" pattern="^[0-9]*$" />
                            <label>extendedtoolkit path</label>
                            <div class="relativediv">
                                <label class="select_path_btn" for="toolkitpath">Browse</label>
                                <input id="toolkitpath" class="out_of_display">
                                <div class="login_input toolkitname">
                                    <span id="file-selected"></span>
                                </div>
                            </div>
                            <label class="inline_block">indesign version</label>
                            <div class="id_version">
                                <input type="radio" name="version" id="is_CS6" onchange="valueChanged1()" value="cs6">
                                <span>CS6</span>
                                <input type="radio" name="version" id="is_CC" onchange="valueChanged2()" value="cc">
                                <span>CC</span>
                            </div>
                            <button id="credsSave" class="large_button">SAVE CREDENTIALS &amp; LOGIN</button>
                            <!--  END  -->
                        </div>
                    </div>
                </div>
                <div class="col-md-4"></div>
            </div>
            <div class="row">
                <div class="col-md-7">
                </div>
                <div class="col-md-5">
                    <img class="footerimg positioning" src="images/pagemajik.svg">
                </div>
            </div>
        </div>
    </div>
    <div id="loadingpage" class="login_wrap loadingpage">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-2"></div>
                <div class="col-sm-8">
                    <div class="loading_wrap" style="margin-top: 148px;">
                        <div class="row">
                            <div class="col-sm-4"></div>
                            <div class="col-sm-4">
                                <div class="login_container">
                                    <div class="header_logo head1 align_center">
                                        <img src="images/easytype.svg">
                                        <span>easytype</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-4"></div>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-pmload">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-2"></div>
            </div>
            <div class="row">
                <div class="col-sm-7">
                </div>
                <div class="col-sm-5">
                    <img class="footerimg" src="images/pagemajik.svg">
                </div>
            </div>
        </div>
    </div>
    <div id="contentpage" class="page_wrap contentpage">
        <div class="fixed_header">
            <img src="images/easytype.svg">
            <span>easytype</span>
            <button class="configure" onclick="configs();">Configure</button>
        </div>
        <div class="container-fluid" style="min-height:48px; margin-bottom: 15px;">
            <div class="row">
                <div class="col-sm-2"></div>
                <div class="col-sm-8">
                    <!--  ERROR BOX-->
                    <div class="errorbox" style="display: none;">
                        <p id="error">EXTENDEDTOOLKIT PATH INCORRECT OR NOT FOUND. REINITIALISE!
                            <a href="#">CLICK HERE</a>
                        </p>
                    </div>
                    <!--  END  -->
                </div>
                <div class="col-sm-2"></div>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-sm-4">
                    <div id="cblist" class="contentstable contentsleft">

                        <!--  SITE HEADING  -->
                        <div class="content_header">
                            <input class="hidden" type="checkbox" id="box-1">
                            <label for="box-1">AVAILABLE SITES</label>
                        </div>
                        <!--  END  -->
                        <!--  SITE NAME  -->
                        <!-- <div class="content_header content_list_left">
                            <input class="hidden" type="checkbox" id="box-2">
                            <label for="box-2">Backup Springer</label>
                        </div> -->
                        <!--  END  -->
                        <!-- <div class="content_header content_list_left">
                            <input class="hidden" type="checkbox" id="box-3">
                            <label for="box-3">FA Davis</label>
                        </div>
                        <div class="content_header content_list_left">
                            <input class="hidden" type="checkbox" id="box-4">
                            <label for="box-4">Guest</label>
                        </div>
                        <div class="content_header content_list_left">
                            <input class="hidden" type="checkbox" id="box-5">
                            <label for="box-5">KLI</label>
                        </div>
                        <div class="content_header content_list_left">
                            <input class="hidden" type="checkbox" id="box-6">
                            <label for="box-6">Lambda</label>
                        </div>
                        <div class="content_header content_list_left">
                            <input class="hidden" type="checkbox" id="box-7">
                            <label for="box-7">oddint Media</label>
                        </div> -->
                    </div>
                </div>
                <div class="col-sm-8">
                    <div class="contentstable contentsright">
                        <!--  PROCESS HEADING  -->
                        <div class="content_header">
                            <label>PROCESSES</label>
                        </div>
                        <!--  END  -->
                        <ul class="nav nav-pills">
                            <li class="active">
                                <a data-toggle="pill" href="#menu1" class="active show" style="border-left: none;">In Progress</a>
                            </li>
                           <!--  <li>
                                <a data-toggle="pill" href="#menu2" onclick="refreshcdata()">Completed</a>
                            </li>
                            <li>
                                <a data-toggle="pill" href="#menu3" onclick="refreshfdata()">Failed</a>
                            </li> -->
                        </ul>

                        <div class="tab-content">
                            <div id="menu1" class="tab-pane  active show">
                                <!--  IN-PROGRESS HEADING  -->
                                <!-- <div class="content_list_right">
                                    <span>Filename.extension</span>
                                </div> -->
                                <!--  END  -->
                                <!--  <div class="content_list_right">
                                    <span>thisisareallylongfilenamethatihaveaddedtoshowhowthelinebreakswork.xhtml</span>
                                </div> -->
                            </div>
                            <div id="menu2" class="tab-pane">
                                <div id="completed-table"></div>
                                <!--  COMPLETED HEADING  -->
                                <!-- <div class="content_list_right">
                                    <span>Filename.extension</span>
                                </div> -->
                                <!--  END  -->
                                <!-- <div class="content_list_right">
                                    <span>Sample.extension</span>
                                </div> -->
                            </div>
                            <div id="menu3" class="tab-pane">
                                <div id="failed-table"></div>
                                <!--  FAILED HEADING  -->
                                <!-- <div class="content_list_right">
                                    <span>icantthinkofafilename.extension</span>
                                </div> -->
                                <!--  END -->
                                <!-- <div class="content_list_right">
                                    <span>omglolololol.xhtml</span>
                                </div> -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row" style="margin-top: 15px;">
                <div class="col-sm-12">
                    <!--  FOOTER BUTTONS  -->
                    <button class="footer_btn" onclick="buildSitesSelected()">SYNC SITES</button>
                    <button class="footer_btn pull-right start_btn" onclick="startpen()">START</button>
                    <button class="footer_btn pull-right" onclick="winReload()">RESTART APP</button>
                    <!--  END  -->
                </div>
            </div>

        </div>
    </div>
    <script src="JS/jquery-3.2.1.js"></script>
    <script src="JS/jquery-ui.js"></script>
    <script src="bootstrap/js/bootstrap.js"></script>
    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.5.2/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tabulator/3.5.2/js/tabulator.min.js"></script>
    --> <script>
        var app = nodeRequire('electron').remote;
        const BrowserWindow = app.BrowserWindow;
        var request = nodeRequire('request');
        var _ = nodeRequire('lodash');
        var rp = nodeRequire('request-promise');
        const os = nodeRequire('os');
        var Promise = nodeRequire('promise');
        var fse = nodeRequire("fs-extra");
        //var sfs = nodeRequire('@mh-cbon/sudo-fs');
        var http = nodeRequire('http');
        var miscellaneousFolderID = "";
        var osascript = nodeRequire('node-osascript');
        var prepend = nodeRequire('prepend-file');
        var download = nodeRequire('download-file')
        var cmd = nodeRequire('node-cmd');
        var chokidar = nodeRequire('chokidar');
        var webdav = nodeRequire('./windows.js')
        var exec = nodeRequire('child_process').exec
        var spawn = nodeRequire('child_process').spawn
        const osName = nodeRequire('os-name');
        var URL = nodeRequire('url-parse');
        const fixPath = nodeRequire('fix-path')();
        var copy = nodeRequire('recursive-copy');
        //var applescript = nodeRequire('applescript');
        var heimdall;
        var loki;
        var output = localStorage.getItem('output');
        var fs = nodeRequire("fs");
        const fileExists = nodeRequire('file-exists');
        var sitecount;
        var selectedSites = "";
        var currentsite;
        var PAGEMAJIK_DOWNLOAD_PATH = os.homedir() + "/" + "PageMajik/";
        var final;
        var getIndesignSupBool = false;
        var javascriptContent = "";
        var URL_PAGEMAJIK_PENDING;
        var URL_FileVersion;
        var URL_FileEntry;
        var URL_cancelCheckout_download;
        var URL_cancelCheckout;
        var URL_getAllFiles;
        var FailedFiles = [];
        var process1 = app.process;
        var DecompressZip = nodeRequire('decompress-zip');
        //  console.log(hostname)

        var SITE_URL
        var DEFAULT_USER
        var DEFAULT_PASS



        var webDavURL;
        var dat;
        var pagenum;
        var First = true;
        var batdat;
        var drivemounted = false;
        var checkEx = false;
        var checkSc = false;
        var selected = [];
        var sitesready = false;
        var credsready = false;
        var currentfile;
        var statusfileuserID;
        var filename;
        var fileFolderId;
        var artFolderId = "";
        var fileExtension;
        var notifyuserID;
        var fileMimeType;
        var fileDescription;
        var fileTreePath;
        var fileEntryId;
        var process;
        var stage;
        var filePath;
        var EXT_PATH;
        var indesignScriptInpPath
        var companyID;
        var fileuserID;
        var scriptsfolderID;
        var FontsID;
        var BookLevelAdobeScriptID;
        var SupportID;
        var LibraryID;
        var PresetID;
        var SiteLevelAdobeScriptID;
        var ClientLevelAdobeScriptID;
        var ClientLevelPagemajikScriptID;
        var ezTypeUserID = "";
        var display = "";
        var InstructionID;
        var SiteLevelPagemajikScriptID;
        var BookLevelPagemajikScriptID;
        var ReviewID;
        var MiscellaneousID;
        var fileRepFolderId;
        var chapterID;
        var watcher;
        var retry;
        var selectedId = [];
        var VER;
        var gc = 0;
        var currentrun = true;
        var scriptsPath = os.homedir() + "/" + "Documents/Adobe Scripts/";
        var scriptsPath1 = os.homedir() + "\\" + "Docume+nts\\Adobe Scripts\\";
        var scriptsPath2 = scriptsPath1.replace("/", "\\");
        var scriptsPath2 = scriptsPath2.replace("/", "\\");
        var progress = 0;
        var supportPath;
        var supportPath2;
        var fontsFolderPath;
        var presetFileName;
        var allgood = true;
        var inddokay = true;
        var BookMapID;
        var max = 0
        var min = 0

        var indesignScriptPath = scriptsPath;


      //  fse.emptyDir(scriptsPath)


    //    fse.emptyDir(PAGEMAJIK_DOWNLOAD_PATH)

        fse.emptyDir(os.homedir() + "/Library/Logs/DiagnosticReports")
        const {
            dialog
        } = nodeRequire('electron').remote
        var EXTpath = '';
        $('#toolkitpath').click(function () {
            /* EXTpath = $(this).val();
            $('#file-selected').html(EXTpath);
            localStorage.setItem("EXT_PATH", EXTpath);
            console.log(EXTpath) */
            dialog.showOpenDialog({
                properties: ['openFile']
            }, function (fileNames) {
                console.log(fileNames)
                $('#file-selected').html(fileNames);
                EXT_PATH = fileNames
                console.log(EXT_PATH)
                localStorage.setItem("EXT_PATH", fileNames);
                console.log(localStorage.getItem('EXT_PATH'))
            });



        });


        $.fn.extend({
            qcss: function (css) {
                return $(this).queue(function (next) {
                    $(this).css(css);
                    next();
                });
            }
        });

        function winReload() {
            mainWindow = new BrowserWindow({
                useContentSize: true,
                width: 1200,
                height: 600,
                webPreferences: {
                    nodeIntegration: true,
                    webSecurity: false,
                },
            });
            mainWindow.loadURL('file://' + __dirname + '/mainpage_mac_sev.html');
            window.close();
        }

        //siteName
        $("#siteName").val(localStorage.getItem("SITE_id"))
        $("#userName").val(localStorage.getItem("USER_id"))
        $("#password").val(localStorage.getItem("PASS_id"))
        $("#file-selected").html(localStorage.getItem("EXT_PATH"))


        if (localStorage.getItem('EXT_PATH') !== null) {
            checkEx = true;
        }

        if (localStorage.getItem('SITE_id') !== null) {
            checkSc = true;
        }

        function valueChanged1() {
            if (document.getElementById("is_CS6").checked == true) {
                //document.getElementById("is_CS6").value = 1;
                document.getElementById("is_CC").checked = false;
            }
        }

        function valueChanged2() {
            if (document.getElementById("is_CC").checked == true) {
                document.getElementById("is_CS6").checked = false;
            }
        }

        $("#credsSave").click(function () {
            $(".loginpage").css("display", "none");
            $(".loadingpage").css("display", "block");
            $(".bg-pmload").delay(1000).qcss({
                width: "100%"
            });
            $(".loadingpage").delay(4000).qcss({
                display: "none"
            });
            $(".contentpage").delay(4000).qcss({
                display: "block"
            });
            credsSave();
        });


        function credsSave() {
            SITE_URL = document.getElementById('siteName').value
            DEFAULT_USER = document.getElementById('userName').value
            DEFAULT_PASS = document.getElementById('password').value
            MAX = document.getElementById('max').value
            MIN = document.getElementById('min').value

            if (MAX == "" || MIN == "") {

            } else {
                localStorage.setItem("MAX", MAX)
                localStorage.setItem("MIN", MIN)
            }
            if (document.getElementById("is_CS6").checked == true) {
                localStorage.setItem("VER", "CS6")
            } else {
                localStorage.setItem("VER", "CC")
            }
            if (SITE_URL == "" || SITE_URL == null) {
                if (localStorage.getItem('SITE_id') == "" || localStorage.getItem('SITE_id'))
                    $(".errorbox").css("display", "block");
                $('#error').text('SITE URL IS NOT SET');
            } else {
                localStorage.setItem('SITE_id', SITE_URL);
            }

            if (DEFAULT_PASS == "" || DEFAULT_PASS == null || DEFAULT_USER == "" || DEFAULT_PASS == "") {

            } else {
                localStorage.setItem('USER_id', DEFAULT_USER);
                localStorage.setItem('PASS_id', DEFAULT_PASS);
            }
            console.log(SITE_URL);
            console.log(DEFAULT_USER);
            console.log(DEFAULT_PASS);
            VER = localStorage.getItem("VER")
            console.log(VER);
            console.log(EXTpath)




            // localStorage.setItem("EXT_PATH", EXTpath);

            var buildPromise = buildsites();
            retry = 0;
            buildPromise.then(function (result) {
                // // console.log("nextline");
                console.log(result);
                var selected = [];

            }, function (err) {
                console.log(err);
            })



        }
        $(".loginpage").css("display", "none");
        $(".loadingpage").css("display", "none");
        $(".contentpage").css("display", "block");
        console.log(window.location.href)

        DEFAULT_USER = localStorage.getItem('USER_id');
        DEFAULT_PASS = localStorage.getItem('PASS_id');
        SITE_URL = localStorage.getItem('SITE_id')
        EXT_PATH = localStorage.getItem('EXT_PATH')
        VER = localStorage.getItem("VER")
        var buildPromise = buildsites();
        retry = 0;
        // console.log()
        sitesready = true
        buildPromise.then(function (result) {
            // // console.log("nextline");
            console.log(result);
            var selected = [];

        }, function (err) {
            console.log(err);
        }).then(function (result) {
            selectedSites = localStorage.getItem("SSites")
            console.log(selectedSites)
            selectedId = localStorage.getItem("SId")
            selectedId = selectedId.split(',')
            console.log(selectedId.length)
            for (var item in selectedId) {
                $("#" + selectedId[item]).prop('checked', 'true');
            }

            startpen();
        })



        function configs() {
            $(".bg-pmload").delay(1000).qcss({
                width: "0%"
            });
            $(".loginpage").css("display", "block");
            $(".loadingpage").css("display", "none");
        }



        function buildSitesSelected() {
            selectedSites = "";
            $('.checkclass:checkbox:checked').each(function () {
                //   console.log(this.value)
                selectedSites += this.value + "%2C"
            });

            //   console.log(selected)
            //for(i=0;i<selected.length;i++)
            //selectedSites = selected.pop() + "%2C"
            console.log(selectedSites);
            sitesready = true;
        }

        function buildsites() {
            // Setting URL and headers for request
            SITE_URL = localStorage.getItem("SITE_id");
            var tmpcheck = SITE_URL +
                "/api/jsonws/group/get-user-sites"
            console.log(tmpcheck)

            var options = {
                method: 'GET',
                uri: tmpcheck,
                auth: {
                    'user': DEFAULT_USER,
                    'pass': DEFAULT_PASS
                },
                timeout: 240000,
                resolveWithFullResponse: true
            };
            // Return new promise 
            return new Promise(function (resolve, reject) {
                // Do async job

                rp(options)
                    .then(function (response) {
                        // POST succeeded...
                        var USER_SITES_DETAILS = JSON.parse(response.body);
                        //   console.log(USER_SITES_DETAILS);
                        //   console.log(USER_SITES_DETAILS.length);
                        sitecount = USER_SITES_DETAILS.length;
                        for (var i = 1; i < USER_SITES_DETAILS.length; i++) {
                            console.log(USER_SITES_DETAILS[i].name, USER_SITES_DETAILS[i].groupId)
                            //selectedSites += USER_SITES_DETAILS[i].name + "%2C";
                            addCheckbox(USER_SITES_DETAILS[i].name, USER_SITES_DETAILS[i].groupId);

                        }

                        //   console.log(selectedSites)
                        return resolve(selectedSites)

                    })
                    .catch(function (err) {
                        // POST failed...
                        console.log(err)
                        setTimeout(buildsites, 5000)
                        return reject(err);
                    });
            })

        }


        function addCheckbox(name, groupid) {
            var container = $('#cblist');
            var inputs = container.find('input');
            var id = inputs.length + 1;


            /* $('<div>', {
                class: "content_header content_list_left",
            }).appendTo(container) */

            $(container).append("<div class='content_header content_list_left'>" +
                $('<input />', {
                    type: 'checkbox',
                    id: 'cb' + id,
                    class: 'hidden checkclass',
                    value: groupid
                })[0].outerHTML +
                $('<label />', {
                    'for': 'cb' + id,
                    text: name
                })[0].outerHTML + "</div>")

            /*     $('<input />', {
                    type: 'checkbox',
                    id: 'cb' + id,
                    class: 'checkclass',
                    value: groupid
                }).appendTo(container);
                $('<label />', {
                    'for': 'cb' + id,
                    text: name
                }).appendTo(container); */
            /*       $('</div>', {

                  }).appendTo(container) */
        }
        function pendingfiles() {
            // Setting URL and headers for request
            var VER = localStorage.getItem("VER");
            if (VER == null || VER == "" || VER == "undefined") {
                Alert("No version Selected");
            }
            var pending_files = URL_PAGEMAJIK_PENDING + "/group-ids/" + selectedSites +
                "/indd-version/" + VER;
            console.log(JSON.stringify(pending_files))
            var options = {
                method: 'POST',
                uri: pending_files,
                auth: {
                    'user': DEFAULT_USER,
                    'pass': DEFAULT_PASS










                },
                timeout: 240000,
                resolveWithFullResponse: true
            };
            // Return new promise 

            return new Promise(function (resolve, reject) {
                // Do async job
                rp(options)
                    .then(function (response) {
                        // POST succeeded...
                        currentfile = JSON.parse(response.body);
                        if (response.body.match("exception")) {
                            setTimeout(startpen, 5000)
                            var container = $('#menu1');
                            //var inputs = container.find('div');
                            var id = filename;


                            /* $('<div>', {
                                class: "content_header content_list_left",
                            }).appendTo(container) */
                            if (progress == 0) {
                                $(container).append("<div class='content_list_right'>" +
                                    "<span>" + "Waiting for Server ." + "</span>" +
                                    "</div>");
                                progress++;
                            }
                            if (progress == 1) {
                                $(container).append("<div class='content_list_right'>" +
                                    "<span>" + "Waiting for Server .." + "</span>" +
                                    "</div>")
                                progress++;
                            }

                            if (progress == 2) {
                                $(container).append("<div class='content_list_right'>" +
                                    "<span>" + "Waiting for Server ..." + "</span>" +
                                    "</div>")
                                progress = 0;
                            }


                        } else {
                            return resolve(currentfile)
                        }

                    })
                    .catch(function (err) {
                        // POST failed...
                        console.log(err)
                        console.log("getting pending files failed. Am definitely not in, ...Going back")
                        setTimeout(startpen, 5000)
                        return reject(err);

                    });
            })

        }

        async function startpen() {
            if (true) {
                credsready = true

                console.log(EXT_PATH)
                console.log(VER)
                console.log(SITE_URL);
                console.log(DEFAULT_USER);
                console.log(DEFAULT_PASS);

                /*  DEFAULT_USER = params.searchParams.get("a")
                 DEFAULT_PASS = params.searchParams.get("b")
                 EXT_PATH = params.searchParams.get("c")
                 VER = params.searchParams.get("d")
                 localStorage.setItem('USER_id', DEFAULT_USER);
                 localStorage.setItem('PASS_id', DEFAULT_PASS);
                 localStorage.setItem('SITE_id', SITE_URL);
                 localStorage.setItem("VER", VER) */
                // webDavURL = getwebDavURL();


                URL_getAllFiles = SITE_URL + "/api/jsonws/Dazzle-portlet.pagemajik/folder-zip /folder-id/";
                URL_PAGEMAJIK_PENDING = SITE_URL +
                    "/api/jsonws/Dazzle-portlet.pagemajik/find-by-file-name/status/Pending";
                //  console.log(URL_PAGEMAJIK_PENDING)
                URL_FileVersion = SITE_URL +
                    "/api/jsonws/dlfileversion/get-latest-file-version/file-entry-id/";
                URL_FileEntry = SITE_URL + "/api/jsonws/dlapp/get-file-entry/file-entry-id/";
                URL_cancelCheckout_download = SITE_URL +
                    "/api/jsonws/Dazzle-portlet.pagemajik/universal-service/file-entry-id/"
                URL_cancelCheckout = SITE_URL + "/api/jsonws/dlapp/cancel-check-out/file-entry-id/"








            }
            if (true) {
                //var pendingPromise = ;
                timer = '';
                pending_start();
                timer = setTimeout(startpenstuck, 1800000)




            }
        }


        async function startpenstuck() {


            sendNotification(companyID, fileRepFolderId, ezTypeUserID,
                "",
                "", ezTypeUserID, filename + " " + display +
                "File exceeded the allocated time to complete the task. Please RUN and try again", false,
                statusfileuserID);

            cancel_checkout(fileEntryId);

            fse.emptyDir(os.homedir() + "/Library/Logs/DiagnosticReports")
            try {
                watcher.close();
            } catch (error) {
                console.log("Watcher didn't close or it had never started")
            }

          //  fse.emptyDir(scriptsPath)


         //   fse.emptyDir(PAGEMAJIK_DOWNLOAD_PATH)

            if (checkEx == true && checkSc == true) {
                credsready = true

                // webDavURL = getwebDavURL();
                fse.emptyDir(os.homedir() + "/Library/Logs/DiagnosticReports")

                URL_getAllFiles = SITE_URL + "/api/jsonws/Dazzle-portlet.pagemajik/folder-zip/folder-id/";
                URL_PAGEMAJIK_PENDING = SITE_URL +
                    "/api/jsonws/Dazzle-portlet.pagemajik/find-by-file-name/status/Pending";
                //  console.log(URL_PAGEMAJIK_PENDING)
                URL_FileVersion = SITE_URL +
                    "/api/jsonws/dlfileversion/get-latest-file-version/file-entry-id/";
                URL_FileEntry = SITE_URL + "/api/jsonws/dlapp/get-file-entry/file-entry-id/";
                URL_cancelCheckout_download = SITE_URL +
                    "/api/jsonws/Dazzle-portlet.pagemajik/universal-service/file-entry-id/"
                URL_cancelCheckout = SITE_URL + "/api/jsonws/dlapp/cancel-check-out/file-entry-id/"

                //  var ff = [];
                //   ff.push(localStorage.getItem("FailedFiles"));
                //   ff.push(filename)
                //   localStorage.setItem("FailedFiles", ff);

                //kill $(ps aux | grep '[C]ontents/MacOS/Adobe InDesign' | awk '{print $2}')

                var child = exec("kill $(ps aux | grep '[C]ontents/MacOS/Adobe InDesign' | awk '{print $2}')", {
                        cwd: os.homedir()
                    },
                    function (error, stdout, stderr) {
                        console.log('stdout: ' + stdout);
                        console.log('stderr: ' + stderr);
                        if (error !== null) {
                            console.log('exec error: ' + error);
                        }
                    });
                child.stdout.on('data', function (data) {
                    //pendingfiles();
                    console.log(data)

                })

                fse.emptyDir(os.homedir() + "/Library/Preferences/Adobe\ InDesign");

                /*   var child = exec("rm -rf " + os.homedir() + "/Library/Preferences/Adobe\ InDesign", {
                          cwd: os.homedir()
                      },
                      function (error, stdout, stderr) {
                          console.log('stdout: ' + stdout);
                          console.log('stderr: ' + stderr);
                          if (error !== null) {
                              console.log('exec error: ' + error);
                          }
                      });
                  child.stdout.on('data', function (data) {
                      //pendingfiles();
                      //  console.log(data)

                  }) */




            }
            if (credsready == true && sitesready == true) {
                //var pendingPromise = ;
                timer = '';
                pending_start();
                timer = setTimeout(startpenstuck, 1800000)




            }

        }

        function pending_start() {
            first = false;
            console.log("Am in")
            gc++;
            EXT_PATH = localStorage.getItem('EXT_PATH')
            localStorage.setItem("SSites", selectedSites)
            localStorage.setItem("SId", selectedId)
            max = localStorage.getItem("MAX");
            min = localStorage.getItem("MIN")

            /*  params = queryString.stringify({
                 DEFAULT_USER: DEFAULT_USER,
                 DEFAULT_PASS: DEFAULT_PASS,
                 EXT_PATH: EXT_PATH,
                 VER: VER
             }) */

            if (gc == 7000) {
                //  alert("Memory Alert")
                mainWindow = new BrowserWindow({
                    useContentSize: true,
                    width: 1200,
                    height: 600,
                    webPreferences: {
                        nodeIntegration: true,
                        webSecurity: false,
                    },
                });
                mainWindow.loadURL('file://' + __dirname + '/mainpage_mac1_sev.html');
                window.close();
            }
            //  var getFFbox = document.getElementById('FailedFiles');
            //   var ffiles = localStorage.getItem("FailedFiles");
            //    getFFbox.value = ffiles;
            if (credsready == true && sitesready == true) {
                pendingfiles().then(function (result) {
                        function isEmpty(obj) {
                            for (var key in obj) {
                                if (obj.hasOwnProperty(key))
                                    return false;
                            }
                            return true;
                        }
                        if (isEmpty(result)) {
                            // // console.log("nextline");
                            console.log(result);
                            clearTimeout(
                                timer);
                                if(min ==0 && max==0){
                                setTimeout(pending_start,5000)
                            } else {
                                var rand = _.random(min,max)
                                setTimeout(pending_start, (5000 + (rand * 1000)))
                            console.log(rand + 5)

                            }

                            var container = $('#menu1');
                            //var inputs = container.find('div');
                            var id = filename;
                            $(container).empty();
                            /* $('<div>', {
                                class: "content_header content_list_left",
                            }).appendTo(container) */
                            if (progress == 0) {
                                $(container).empty()
                                $(container).append("<div class='content_list_right'>" +
                                    "<span>" + "Fetching files ." + "</span>" +
                                    "</div>");
                                progress++;
                            } else if (progress == 1) {
                                $(container).empty()
                                $(container).append("<div class='content_list_right'>" +
                                    "<span>" + "Fetching files .." + "</span>" +
                                    "</div>")
                                progress++;
                            } else {
                                $(container).empty()
                                $(container).append("<div class='content_list_right'>" +
                                    "<span>" + "Fetching files ..." + "</span>" +
                                    "</div>")
                                progress = 0;
                            }

                        } else {
                            console.log(result);
                            var pandora = localStorage.getItem("pandora")
                            if (pandora == "") {
                                localStorage.setItem("pandora", "0");
                            } else {
                                pandora++;
                                localStorage.setItem("pandora", pandora);
                            }
                            if (pandora == 10) {
                                // alert("MayDay MayDay MayDay")
                                pandora = 0;
                                localStorage.setItem("pandora", pandora);
                            }

                            if (result.fileEntryId !== null && result.fileEntryId !== "undefined") {
                                fileEntryID = result.fileEntryId;
                                //   console.log(fileEntryID);
                                process = result.process;
                                //   console.log(process);
                                filePath = result.filePath;
                                console.log(filePath);
                                filepathbroken = filePath.split('/')
                                console.log(filepathbroken)

                                stage = result.field5
                                //    console.log(stage);
                                filePath = filePath.replace("Z:", "");
                                //   console.log(filePath);
                                currentProcess = process;
                                var filePresetID = "";
                                statusfileuserID = result.userId;
                            } else {
                                var container = $('#menu1');
                                $(container).append("<div class='content_list_right'>" +
                                    "<span>" + "Unable to get file... Moving on" + "</span>" +
                                    "</div>")
                                // gotonextfile();
                                // break;
                            }
                            if (result.preset !== null) {
                                filePresetID = result.preset;
                            }

                            currentfile = "";
                            retry = 0
                            getFileObject(fileEntryID).then(async function (result) {
                                    //  console.log("GFOnextline");
                                    console.log(result);
                                    /*if (result.exception.match('NoSuchFileEntryException') || (result.status == 8)) {
                                        console.log("File is Deleted");
                                    }*/

                                    filename = result.title;
                                    fileFolderId = result.folderId;
                                    fileRepFolderId = result.groupId;
                                    fileExtension = result.extension;
                                    fileMimeType = result.mimeType;
                                    fileDescription = result.description;
                                    fileTreePath = result.treePath;
                                    companyID = result.companyId;
                                    fileuserID = result.userId;
                                    notifyuserID = result.userId;
                                    indesignScriptInpPath = PAGEMAJIK_DOWNLOAD_PATH +
                                        fileRepFolderId +
                                        "/" +
                                        fileFolderId + "/" + filename;

                                    console.log(indesignScriptInpPath)

                                    addFileToInProgress(filename);

                                    getUserIdByScreenName(companyID, DEFAULT_USER).then(function (result) {
                                        ezTypeUserID = result;
                                    });

                                        await getAllFolderID(fileEntryID,
                                        fileRepFolderId).then(function (result) {
                                        console.log(result)
                                        BookMapID = result.BookMap
                                        getBookmapPageNumber(BookMapID, filename).then(function (result) {
                                            console.log("PageNum is " + JSON.stringify(result));
                                            if (JSON.stringify(result) == "{}") {
                                                //pagenum = 10
                                                pagenum = 1
                                            } else {
                                                pagenum = JSON.stringify(result)
                                            }

                                        })
                                    })



                                    inddokay = true;
                                    //  console.log(filename);
                                    //   console.log(fileFolderId);
                                    //   console.log(fileRepFolderId);
                                    //   console.log(fileExtension);
                                    //   console.log(fileMimeType);
                                    //  console.log(fileDescription);
                                    //   console.log(fileTreePath);
                                    //   console.log(companyID);
                                    //    console.log(fileuserID);
                                    var downloadPath = PAGEMAJIK_DOWNLOAD_PATH + fileRepFolderId +
                                        "/" +
                                        fileFolderId;
                                 //   fse.emptyDir(PAGEMAJIK_DOWNLOAD_PATH)
                                    //call universal service to put in progress and get downloadURL
                                    var downloadURL;
                                    var downloadURLpromise = cancel_checkout_download(fileEntryID,
                                        fileRepFolderId);
                                    downloadURLpromise.then(function (result) {
                                            // console.log("nextline");
                                            console.log(result.URL);
                                            downloadURL = result.URL;
                                            //console.log(fileRepFolderId)


                                            // console.log(SITE_URL + downloadURL);
                                            fse.ensureDirSync(downloadPath);
                                            console.log(downloadPath)
                                            console.log("File Entry ID is :" + fileEntryID)
                                            bfileEntryId = fileEntryId;
                                            var received_bytes;
                                            url = SITE_URL + downloadURL;
                                            scriptsPath = scriptsPath + "/" + fileEntryID
                                            indesignScriptPath = scriptsPath;
                                            fse.ensureDirSync(scriptsPath)

                                            rp.get({
                                                    uri: url,
                                                    auth: {
                                                        'user': DEFAULT_USER,
                                                        'pass': DEFAULT_PASS
                                                    }
                                                })
                                                .on('response', function (data) {

                                                    total_bytes = parseInt(data.headers[
                                                        'content-length']);
                                                    console.log(data.statusCode);
                                                    return console.log(data)

                                                })
                                                /*.on('data', function (chunk) {
                                                                                                    received_bytes += chunk.length;
                                                                                                    return console.log(chunk); */
                                                .on('error', function (err) {
                                                    var container = $('#menu1');
                                                    $(container).append(
                                                        "<div class='content_list_right'>" +
                                                        "<span>" +
                                                        "Unable to Download Indesign File..Moving on" +
                                                        "</span>" +
                                                        "</div>")
                                                    //  gotonextfile();
                                                    return console.log(err);
                                                    inddokay = false;
                                                })
                                                .pipe(fs.createWriteStream(downloadPath + '/' +
                                                    filename));

                                            /* var supportPath3 = supportPath.replace(/\//g, '\\')
                                            supportPath3 = supportPath3.replace(/\\/g, '\\\\')
                                            indesignScriptInpPath = indesignScriptInpPath.replace(
                                                /\//g,
                                                '\\')
                                            indesignScriptInpPath = indesignScriptInpPath.replace(
                                                /\\/g,
                                                '\\')
                                            indesignScriptPath = indesignScriptPath.replace(
                                                /\//g, '\\')
                                            indesignScriptPath = indesignScriptPath.replace(
                                                /\\/g, '\\') */
                                            javascriptContent = '';

                                            javascriptContent = javascriptContent +
                                                "#target indesign" +
                                                "\n"
                                            javascriptContent = javascriptContent +
                                                "#targetengine  \"session\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                "app.scriptPreferences.userInteractionLevel = UserInteractionLevels.NEVER_INTERACT" +
                                                "\n"
                                            javascriptContent = javascriptContent +
                                                " var	inputFilePath = \"" +
                                                indesignScriptInpPath + "\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                " var	scriptsFilePath = \"" +
                                                indesignScriptPath + "\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                " var pagenum =" +
                                                pagenum + "\n"
                                            javascriptContent = javascriptContent +
                                                " var PageNumStyle = \"" +
                                                "" + "\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                " var webDavAddress = \"" +
                                                supportPath2 + "Links" + "\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                " var userName = \"" +
                                                DEFAULT_USER + "\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                " var userCred = \"" +
                                                DEFAULT_PASS + "\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                " var fileEntryId = \"" +
                                                fileEntryID + "\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                " var process = \"" +
                                                process + "\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                " var filename = \"" +
                                                filename + "\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                " var fileFolderId = \"" +
                                                fileFolderId + "\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                " var fileRepFolderId = \"" +
                                                fileRepFolderId + "\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                " var fileExtension = \"" +
                                                fileExtension + "\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                " var fileMimeType = \"" +
                                                fileMimeType + "\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                " var fileDescription = \"" +
                                                fileDescription + "\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                " var fileTreePath = \"" +
                                                fileTreePath + "\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                " var filePath = \"" +
                                                filePath + "\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                " var companyID = \"" +
                                                companyID + "\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                " var fileuserID = \"" +
                                                statusfileuserID + "\"" + "\n"
                                            javascriptContent = javascriptContent +
                                                " var slugLineInfo = \"" +
                                                stage + "\"" + "\n"

                                            console.log(javascriptContent);
                                            // console.log(downloadURL)
                                            // return resolve();
                                        },
                                        function (err) {
                                            console.log(err);
                                        })







                                    supportPath = PAGEMAJIK_DOWNLOAD_PATH + fileRepFolderId +
                                        "/" +
                                        fileFolderId + "/";

                                    console.log(supportPath)
                                    supportPath2 = supportPath.replace(/\//g, '\\')
                                    supportPath2 = supportPath2.replace(/\/\//g, '\\')

                                    fontsFolderPath = supportPath + "/Document fonts/"
                                    //fse.remove(fontsFolderPath);
                                    fse.ensureDirSync(fontsFolderPath);

                                    console.log(scriptsPath)




                                    /*  prepend(scriptsPath + "PDF_Generator.jsx", function (err) {
                                         if (err) {
                                             return console.log(err);
                                         }

                                         console.log("The ScriptsFile is saved!");
                                     }); */



                                    //fs.closeSync(fs.openSync(indesignScriptInpPath, 'w'));

                                    // fs.closeSync(fs.openSync(scriptsPath, 'w'));



                                    var ancestorFolderIDs = fileTreePath.split('/');
                                    ancestorFolderIDs =
                                        ancestorFolderIDs.reverse();
                                    // console.log(ancestorFolderIDs)
                                    chapterID = ancestorFolderIDs[2];
                                    /*     console.log(chapterID)

                                       // ancestorFolderIDs.splice(ancestorFolderIDs.length - 1, 1)
                                       // ancestorFolderIDs[ancestorFolderIDs.length] = 0;
                                        console.log(ancestorFolderIDs)  */
                                    retry = 0;
                                    var getAllFolderIDPromise = getAllFolderID(fileEntryID,
                                        fileRepFolderId)


                                    if (inddokay) {


                                        getAllFolderIDPromise.then(async function (result) {


                                                // // console.log("nextline");
                                                console.log("getAllfolderID" + JSON.stringify(
                                                    result));



                                                var heimdall = false;
                                                localStorage.setItem("heimdall", "false")
                                                var loki = false;
                                                FontsID = result.Fonts;
                                                BookLevelAdobeScriptID = result.BookLevelAdobeScript;
                                                SupportID = result.Support;
                                                LibraryID = result.Library;
                                                PresetID = result.Preset;
                                                SiteLevelAdobeScriptID = result.SiteLevelAdobeScript;
                                                ClientLevelAdobeScriptID = result.ClientLevelAdobeScript;
                                                ClientLevelPagemajikScriptID = result.ClientLevelPagemajikScript;
                                                InstructionID = result.Instruction;
                                                SiteLevelPagemajikScriptID = result.SiteLevelPagemajikScript;
                                                BookLevelPagemajikScriptID = result.BookLevelPagemajikScript;
                                                ReviewID = result.Review;
                                                MiscellaneousID = result.Miscellaneous;
                                                artFolderId = result.Art;
                                                commonArtFolderId = result.CommonArt
                                                BookMapID = result.BookMap;
                                                contents = "%5B";
                                                //  if (artFolderId != 0) {
                                                //contents.push(artFolderId);
                                                contents = contents + artFolderId
                                                //     }

                                                if (commonArtFolderId != 0) {
                                                    //contents.push(commonArtFolderId);
                                                    contents = contents + "%2C" + commonArtFolderId;
                                                }

                                                if (PresetID != 0) {
                                                    //contents.push(commonArtFolderId);
                                                    contents = contents + "%2C" + PresetID;
                                                    presetFileName = await getPresetFilename(filePresetID);
                                                    console.log(presetFileName)
                                                }
                                                /* var serverPath = await getServerPathSync(
                                                    fileRepFolderId,
                                                    artFolderId); */









                                                console.log(
                                                    "All ID's FID BLAdobeID SupID LibID PreID SLAdobeID CLAdobeID CLPmID InsID SLPmID BLPmID ReviewID MisID CommArt" +
                                                    FontsID + " " + BookLevelAdobeScriptID +
                                                    " " +
                                                    SupportID +
                                                    " " + LibraryID + " " + PresetID + " " +
                                                    SiteLevelAdobeScriptID + " " +
                                                    ClientLevelAdobeScriptID +
                                                    " " + ClientLevelPagemajikScriptID + " " +
                                                    InstructionID +
                                                    " " + SiteLevelPagemajikScriptID + " " +
                                                    BookLevelPagemajikScriptID + " " + ReviewID +
                                                    " " +
                                                    MiscellaneousID + " " + commonArtFolderId)
                                                EXT_PATH = localStorage.getItem('EXT_PATH')
                                                EXT_PATH = EXT_PATH.replace(/ /g, "\\ ")



                                                /*  sendNotification(companyID, fileRepFolderId, ezTypeUserID, "",
                                                "", ezTypeUserID, filename + " " + display +
                                                " running.", false, fileuserID);*/


                                                if (process.match("Auto Correction") || process.match(
                                                        "First Proof")) {

                                                    generateProof();
                                                    //runIndesignScript(scriptsPath + "PDF_Generator.jsx", scriptsPath);


                                                }

                                                if (process.match("Word to IDML")) {

                                                    generateIndesign();
                                                }
                                                //no library download for generate proof

                                            },
                                            function (err) {
                                                console.log(err);
                                                // gotonextfile();
                                            })
                                    } else {
                                        var container = $('#menu1');
                                        $(container).append("<div class='content_list_right'>" +
                                            "<span>" + "Unable to get Indesign file... Moving on" +
                                            "</span>" +
                                            "</div>")
                                        gotonextfile();
                                    }
                                },
                                function (err) {
                                    console.log(err);
                                    //gotonextfile();
                                })

                        }
                    },
                    function (err) {
                        console.log(err);
                        //gotonextfile();
                    })

            } else {
                console.log("Creds or site incomplete")
                clearTimeout(
                    timer);
            }
        }


        async function generateIndesign() {

            {
                display = "generate Indesign";
            }

            /* if (InstructionID != 0)
                await getAllFolderContents(InstructionID,
                    fileRepFolderId); */

            //      function sendNotification(companyID, groupID, userID, type, timeStamp, delivered, payload, archived, receiver) 
            sendNotification(companyID, fileRepFolderId, ezTypeUserID,
                "",
                "", ezTypeUserID, filename + " " + display +
                " running.", false, statusfileuserID);


            var script = EXT_PATH +
            " -host localhost:18383 \"/Users/rdmac/Documents/Adobe Scripts/AutoPagination_Processor_Caller.jsx\"";
            fs.writeFileSync(scriptsPath + "/indd.sh", script, {
                encoding: 'utf8',
                flag: 'w',
                mode: 0777
            })



            if (SiteLevelAdobeScriptID != 0) {
                // contents.push(SiteLevelAdobeScriptID);
                contents = contents + "%2C" + SiteLevelAdobeScriptID;
            }

            if (SiteLevelPagemajikScriptID != 0) {
                // contents.push(SiteLevelPagemajikScriptID);
                contents = contents + "%2C" +
                    SiteLevelPagemajikScriptID;
                //unzip(os.homedir() + "/PageMajik/SLPM.zip", scriptsPath);
            }

            if (FontsID != 0) {
                // contents.push(FontsID)
                contents = contents + "%2C" + FontsID
            }



            if (ClientLevelAdobeScriptID != 0) {
                // contents.push(ClientLevelAdobeScriptID);
                contents = contents + "%2C" + ClientLevelAdobeScriptID
            }

            if (ClientLevelPagemajikScriptID != 0) {
                //contents.push(ClientLevelPagemajikScriptID);
                contents = contents + "%2C" +
                    ClientLevelPagemajikScriptID;
            }



            if (BookLevelAdobeScriptID != 0) {
                //contents.push(BookLevelAdobeScriptID)
                contents = contents + "%2C" + BookLevelAdobeScriptID
            }

            if (BookLevelPagemajikScriptID != 0) {
                //contents.push(BookLevelPagemajikScriptID)
                contents = contents + "%2C" +
                    BookLevelPagemajikScriptID;
            }

            if (InstructionID != 0) {
                //contents.push(InstructionID);
                contents = contents + "%2C" + InstructionID

                //  unzip(os.homedir() + "/PageMajik/InstructionID.zip", supportPath +"/Instruction/");
            }

            if (LibraryID != 0) {
                contents = contents + "%2C" + LibraryID
            }

            contents = contents + "%5D"
            var serverPath = await getServerPathSync(contents,
                fileRepFolderId);
            // var removepath = serverPath

            //    serverPath = serverPath.rsyncPath;
            var patt = /([\s\W])/g;
            serverPath = serverPath.replace(patt, '\\$1');
            console.log(serverPath)



            /* prepend(scriptsPath1 +
                "AutoPagination_Processor_Caller.jsx",
                javascriptContent,
                function (err) {
                    if (err) {
                        return console.log(err);
                    }

                    console.log(
                        "The ScriptsFile is saved!"
                    );
                }); */
            heimdall = await rsyncFetch(serverPath,
                supportPath, "", "")


            //   removefile(removepath);


            /* console.log(SITE_URL +
                '/api/jsonws/RSync-Portlet-portlet.rsync/remove-folder/' +
                encodeURIComponent(removepath)) */

            var data = fs.readFileSync(scriptsPath +
                "AutoPagination_Processor_Caller.jsx").toString().split(
                "\n");
            data.splice(0, 0,
                javascriptContent);
            var text = data.join("\n");
            //console.log(text)
            // scriptsPath2 = scriptsPath2.replace(" ","/ ")
            console.log(scriptsPath1 +
                "AutoPagination_Processor_Caller.jsx")

            //fs.unlink(scriptsPath1 + "PDF_Generator.jsx")
            fs.writeFileSync(scriptsPath +
                "AutoPagination_Processor_Caller.jsx", text, {},
                function (err, data) {
                    console.log(err)
                });


            fs.readdirSync(fontsFolderPath).forEach(file => {
                console.log(file);
                if (file.match(".zip")) {

                    osascript.execute(
                        'tell application "Finder" to open POSIX file \"' +
                        fontsFolderPath + "/" + file + '\"',
                        function (err, result, raw) {
                            if (err) return console.error(
                                err)
                            console.log(result, raw)
                        });

                }

            })

            if (LibraryID != 0) {

            }

            var completedFN = filename.replace(/\.[^/.]+$/,
                "_Completed.txt")
            var bookmapFN = filename.replace(/\.[^/.]+$/,
                "_bookmap.txt")
            var idmlfilename = filename.replace(/\.[^/.]+$/,
                ".idml")
            var inddname = filename.replace(/\.[^/.]+$/,
                ".indd")
            var pdffilename = filename.replace(/\.[^/.]+$/,
                ".pdf")
            var supportPath2 = supportPath.replace(/\//g,
                '\\')
            supportPath2 = supportPath2.replace(/\/\//g,
                '\\')
            console.log(supportPath2 + completedFN);

            finalGP(heimdall);

            function finalGP(heimdall) {
                if (heimdall == "true") {
                    console.log("The gatekeeper allowed me")
                    if (currentrun) {
                        runIndesignScript(scriptsPath)
                        console.log("Am done waiting too")
                        fileExists(supportPath + completedFN).then(
                            exists => {
                                console.log(exists) // OUTPUTS: true or false
                                if (exists == true) {
                                    Console.log("TRUE")
                                    // checkEx = true;
                                } else {
                                    console.log("FALSE")
                                    var crashpath = os.homedir() +
                                        "/Library/Logs/DiagnosticReports"
                                    watcher = chokidar.watch(
                                        supportPath, crashpath, {
                                            persistent: true
                                        });

                                    watcher.add(os.homedir() +
                                        "/Library/Logs/DiagnosticReports/Adobe*"
                                    );
                                    // Something to use when events are received.
                                    var log = console.log.bind(
                                        console);
                                    // Add event listeners.
                                    watcher
                                        .on('add', async function (
                                            path) {
                                            console.log(path)

                                            var tmppath = path.replace(
                                                crashpath +
                                                "/", "")
                                            if (tmppath.match(
                                                    /^Adobe.*\.crash$/g
                                                )) {
                                                console.log(
                                                    "Indesign is a Goner"
                                                )
                                                startpenstuck();
                                                return;
                                            }

                                            if (path ==
                                                supportPath +
                                                completedFN) {
                                                javascriptContent
                                                    = "";
                                                retry = 0;
                                                try {
                                                    await addorupdatefile
                                                        (
                                                            fileRepFolderId,
                                                            fileFolderId,
                                                            inddname,
                                                            supportPath +
                                                            inddname,
                                                            companyID,
                                                            fileuserID,
                                                            "indd")

                                                } catch (error) {
                                                    console.log("Handled")
                                                }


                                                sendNotification
                                                    (companyID,
                                                        fileRepFolderId,
                                                        ezTypeUserID,
                                                        "",
                                                        "",
                                                        ezTypeUserID,
                                                        filename +
                                                        " " +
                                                        display +
                                                        " Complete",
                                                        false,
                                                        statusfileuserID
                                                    );


                                               /*  fse.emptyDir(
                                                    scriptsPath
                                                );
                                                fse.remove(
                                                    supportPath
                                                ) */
                                                await cancel_checkout
                                                    (
                                                        fileEntryId
                                                    )

                                                //                           addFileToCompleted
                                                /* (filename,
                                                    filepathbroken[
                                                        1],
                                                    filepathbroken[
                                                        5],
                                                    process
                                                ) */
                                                watcher.close();
                                                clearTimeout(
                                                    timer);
                                                startpen();

                                            }

                                            if (path ==
                                                supportPath +
                                                bookmapFN) {

                                                fs.readFile(supportPath + bookmapFN, 'utf8', async function (
                                                    err, data) {
                                                    if (err) throw err;
                                                    console.log('OK: ' + filename);
                                                    console.log(data)
                                                    await putBookmapPageNumber(BookMapID, filename,
                                                        data);
                                                });

                                            }
                                            /* fileExists(supportPath2 +
                                                    completedFN)
                                                .then(exists => {
                                                    console.log(exists) // OUTPUTS: true or false
                                                    if (exists == true) {
                                                        Console.log("Got the file")
                                                        // checkEx = true;
                                                    } else {
                                                        console.log("FALSE")
                                                    }
                                                }) */
                                        })
                                    /* .on('change', path => log(
                                        `File ${path} has been changed`))
                                    .on('unlink', path => log(
                                        `File ${path} has been removed`)); */

                                    // More possible events.
                                    watcher
                                        .on('addDir', path => log(
                                            `Directory ${path} has been added`
                                        ))
                                        .on('unlinkDir', path =>
                                            log(
                                                `Directory ${path} has been removed`
                                            ))
                                        .on('error', error => log(
                                            `Watcher error: ${error}`
                                        ))
                                        .on('ready', () => log(
                                            'Initial scan complete. Ready for changes'
                                        ))
                                    /* .on('raw', (event, path, details) => {
                                        log('Raw event info:', event, path,
                                            details); 
                                    }); */
                                }
                            })

                    }
                } else {
                    heimdall = localStorage.getItem(
                        "heimdall")
                    setTimeout(function () {
                        finalGP(heimdall);
                    }, 10000)
                }
            }
        }

        async function generateProof() {
            if (process.match("Auto Correction")) {
                display = "generate Revises";
            } else {
                display = "generate Proof"
            }

            /* if (InstructionID != 0)
                await getAllFolderContents(InstructionID,
                    fileRepFolderId); */

            //      function sendNotification(companyID, groupID, userID, type, timeStamp, delivered, payload, archived, receiver) 
            sendNotification(companyID, fileRepFolderId, ezTypeUserID,
                "",
                "", ezTypeUserID, filename + " " + display +
                " running.", false, statusfileuserID);


            var script = EXT_PATH +
            " -host localhost:18383 \"/Users/rdmac/Documents/Adobe Scripts/PDF_Generator.jsx\"";
            fs.writeFileSync(scriptsPath + "/indd.sh", script, {
                encoding: 'utf8',
                flag: 'w',
                mode: 0777
            })


            if (SiteLevelAdobeScriptID != 0) {
                // contents.push(SiteLevelAdobeScriptID);
                contents = contents + "%2C" + SiteLevelAdobeScriptID;
            }

            if (SiteLevelPagemajikScriptID != 0) {
                // contents.push(SiteLevelPagemajikScriptID);
                contents = contents + "%2C" +
                    SiteLevelPagemajikScriptID;
                //unzip(os.homedir() + "/PageMajik/SLPM.zip", scriptsPath);
            }

            if (FontsID != 0) {
                // contents.push(FontsID)
                contents = contents + "%2C" + FontsID
            }



            if (ClientLevelAdobeScriptID != 0) {
                // contents.push(ClientLevelAdobeScriptID);
                contents = contents + "%2C" + ClientLevelAdobeScriptID
            }

            if (ClientLevelPagemajikScriptID != 0) {
                //contents.push(ClientLevelPagemajikScriptID);
                contents = contents + "%2C" +
                    ClientLevelPagemajikScriptID;
            }



            if (BookLevelAdobeScriptID != 0) {
                //contents.push(BookLevelAdobeScriptID)
                contents = contents + "%2C" + BookLevelAdobeScriptID
            }

            if (BookLevelPagemajikScriptID != 0) {
                //contents.push(BookLevelPagemajikScriptID)
                contents = contents + "%2C" +
                    BookLevelPagemajikScriptID;
            }

            if (InstructionID != 0) {
                //contents.push(InstructionID);
                contents = contents + "%2C" + InstructionID

                //  unzip(os.homedir() + "/PageMajik/InstructionID.zip", supportPath +"/Instruction/");
            }

            contents = contents + "%5D"
            var serverPath = await getServerPathSync(contents,
                fileRepFolderId);
            var removepath = serverPath;

            //    serverPath = serverPath.rsyncPath;
            var patt = /([\s\W])/g;
            serverPath = serverPath.replace(patt, '\\$1');
            console.log(serverPath)


            /* prepend(scriptsPath1 + "PDF_Generator.jsx",
                javascriptContent,
                function (err) {
                    if (err) {
                        return console.log(err);
                    }

                    console.log(
                        "The ScriptsFile is saved!"
                    );
                }); */
            retry = 0
            heimdall = await rsyncFetch(serverPath,
                supportPath, "", "")

            //    removefile(removepath);


            console.log(SITE_URL +
                '/api/jsonws/RSync-Portlet-portlet.rsync/remove-folder/' +
                encodeURIComponent(removepath))
            var data = fs.readFileSync(scriptsPath +
                "PDF_Generator.jsx").toString().split(
                "\n");
            data.splice(0, 0,
                javascriptContent);
            var text = data.join("\n");
            //console.log(text)
            // scriptsPath2 = scriptsPath2.replace(" ","/ ")
            console.log(scriptsPath1 + "PDF_Generator.jsx")

            //fs.unlink(scriptsPath1 + "PDF_Generator.jsx")
            fs.writeFileSync(scriptsPath + "PDF_Generator.jsx", text, {},
                function (err, data) {
                    console.log(err)
                });

            fs.readdirSync(fontsFolderPath).forEach(file => {
                console.log(file);
                if (file.match(".zip")) {


                    try {
                        /* var zip = new AdmZip(fontsFolderPath +
                            "/" +
                            file)
                        zip.extractAllTo(fontsFolderPath, true)
                        console.log("ZIp file is " + file)
                        fs.unlink(fontsFolderPath + "/" + file); */

                        osascript.execute(
                            'tell application "Finder" to open POSIX file \"' +
                            fontsFolderPath + "/" + file +
                            '\"',
                            function (err, result, raw) {
                                if (err) return console.error(
                                    err)
                                console.log(result, raw)
                            });


                    } catch (error) {
                        //ifzipstuck();
                    }

                }

            })
            //    sfs.writeFileSync(scriptsPath1 + "PDF_Generator1.jsx",text,{encoding:'utf8',flag:'w'})

            var completedFN = filename.replace(/\.[^/.]+$/,
                "_Completed.txt")
            var bookmapFN = filename.replace(/\.[^/.]+$/,
                "_bookmap.txt")
            var idmlfilename = filename.replace(/\.[^/.]+$/,
                ".idml")
            var pdffilename = filename.replace(/\.[^/.]+$/,
                ".pdf")

            var supportPath2 = supportPath.replace(/\//g,
                '\\')
            supportPath2 = supportPath2.replace(/\/\//g,
                '\\')

            console.log(supportPath2 + completedFN);

            finalGP(heimdall);

            function finalGP(heimdall) {
                if (heimdall == "true") {
                    console.log("The gatekeeper allowed me")
                    if (currentrun) {
                        runIndesignScript(scriptsPath)
                        console.log("Am done waiting too")
                        fileExists(supportPath + completedFN).then(
                            exists => {
                                console.log(exists) // OUTPUTS: true or false
                                if (exists == true) {
                                    Console.log("TRUE")
                                    // checkEx = true;
                                } else {
                                    console.log("FALSE")
                                    var crashpath = os.homedir() +
                                        "/Library/Logs/DiagnosticReports"
                                    watcher = chokidar.watch(
                                        supportPath, {
                                            persistent: true
                                        });
                                    watcher.add(os.homedir() +
                                        "/Library/Logs/DiagnosticReports/Adobe*"
                                    );

                                    // Something to use when events are received.
                                    var log = console.log.bind(
                                        console);
                                    // Add event listeners.
                                    watcher
                                        .on('add', async function (
                                            path) {
                                            console.log(
                                                path
                                            )
                                            var tmppath = path.replace(
                                                crashpath +
                                                "/", "")
                                            if (tmppath.match(
                                                    /^Adobe.*\.crash$/g
                                                )) {
                                                console.log(
                                                    "Indesign is a Goner"
                                                )
                                                startpenstuck();
                                                return;
                                            }

                                            if (path ==
                                                supportPath +
                                                completedFN
                                            ) {
                                                javascriptContent
                                                    =
                                                    "";
                                                if (
                                                    process
                                                    .match(
                                                        "Auto Correction"
                                                    )) {
                                                    var
                                                        indd =
                                                        filename
                                                        .replace(
                                                            /\.[^/.]+$/,
                                                            ".indd"
                                                        )

                                                    try {
                                                        retry
                                                            =
                                                            0;
                                                        await addorupdatefile
                                                            (
                                                                fileRepFolderId,
                                                                fileFolderId,
                                                                indd,
                                                                supportPath +
                                                                indd,
                                                                companyID,
                                                                fileuserID,
                                                                "indd"
                                                            )
                                                    } catch (error) {
                                                        console.log("handled")
                                                    }

                                                    try {
                                                        retry =
                                                            0;
                                                        await addorupdatefile
                                                            (
                                                                fileRepFolderId,
                                                                ReviewID,
                                                                pdffilename,
                                                                supportPath +
                                                                pdffilename,
                                                                companyID,
                                                                fileuserID,
                                                                "pdf"
                                                            )
                                                    } catch (error) {
                                                        console.log("handled")
                                                    }


                                                    try {
                                                        retry =
                                                            0;
                                                        await addorupdatefile
                                                            (
                                                                fileRepFolderId,
                                                                SupportID,
                                                                idmlfilename,
                                                                supportPath +
                                                                idmlfilename,
                                                                companyID,
                                                                fileuserID,
                                                                "idml"
                                                            )
                                                    } catch (error) {
                                                        console.log("handled")
                                                    }




                                                } else {



                                                    try {
                                                        retry =
                                                            0;
                                                        await addorupdatefile
                                                            (
                                                                fileRepFolderId,
                                                                SupportID,
                                                                idmlfilename,
                                                                supportPath +
                                                                idmlfilename,
                                                                companyID,
                                                                fileuserID,
                                                                "idml"
                                                            )
                                                    } catch (error) {
                                                        console.log("Handled")
                                                    }

                                                    try {
                                                        retry =
                                                            0;
                                                        await addorupdatefile
                                                            (
                                                                fileRepFolderId,
                                                                ReviewID,
                                                                pdffilename,
                                                                supportPath +
                                                                pdffilename,
                                                                companyID,
                                                                fileuserID,
                                                                "pdf"
                                                            )
                                                    } catch (error) {
                                                        console.log("Handled")
                                                    }



                                                }

                                                sendNotification
                                                    (companyID,
                                                        fileRepFolderId,
                                                        ezTypeUserID,
                                                        "",
                                                        "",
                                                        ezTypeUserID,
                                                        filename +
                                                        " " +
                                                        display +
                                                        " Complete",
                                                        false,
                                                        statusfileuserID
                                                    );


                                                console
                                                    .log(
                                                        scriptsPath
                                                    )

                                                await cancel_checkout
                                                    (
                                                        fileEntryId
                                                    )

                                                /* fse.emptyDir(
                                                    scriptsPath
                                                )
                                                fse.remove(
                                                    supportPath
                                                ) */
                                                //                           addFileToCompleted
                                                //  (filename,
                                                //      filepathbroken[
                                                //          1],
                                                //      filepathbroken[
                                                //           5],
                                                //       process
                                                //  )
                                                watcher.close();
                                                clearTimeout(
                                                    timer);
                                                startpen();


                                            }

                                            if (path ==
                                                supportPath +
                                                bookmapFN) {
                                                fs.readFile(supportPath + bookmapFN, 'utf8', async function (
                                                    err, data) {
                                                    if (err) throw err;
                                                    console.log('OK: ' + filename);
                                                    console.log(data)
                                                    await putBookmapPageNumber(BookMapID, filename,
                                                        data);
                                                });
                                            }
                                            /* fileExists(supportPath2 +
                                                    completedFN)
                                                .then(exists => {
                                                    console.log(exists) // OUTPUTS: true or false
                                                    if (exists == true) {
                                                        Console.log("Got the file")
                                                        // checkEx = true;
                                                    } else {
                                                        console.log("FALSE")
                                                    }
                                                }) */
                                        })
                                    /* .on('change', path => log(
                                        `File ${path} has been changed`))
                                    .on('unlink', path => log(
                                        `File ${path} has been removed`)); */

                                    // More possible events.
                                    watcher
                                        .on('addDir', path =>
                                            log(
                                                `Directory ${path} has been added`
                                            ))
                                        .on('unlinkDir',
                                            path => log(
                                                `Directory ${path} has been removed`
                                            ))
                                        .on('error', error =>
                                            log(
                                                `Watcher error: ${error}`
                                            ))
                                        .on('ready', () =>
                                            log(
                                                'Initial scan complete. Ready for changes'
                                            ))
                                    /* .on('raw', (event, path, details) => {
                                        log('Raw event info:', event, path,
                                            details); 
                                    }); */
                                }
                            })
                    }
                } else {
                    heimdall = localStorage.getItem(
                        "heimdall")
                    setTimeout(function () {
                        finalGP(heimdall);
                    }, 10000)
                }

            }
        }


        function getPresetFilename(id) {
            var tmpGPF = URL_FileEntry + id;
            console.log(JSON.stringify(tmpGPF))
            var optionsGPF = {
                method: 'GET',
                uri: tmpGPF,
                auth: {
                    'user': DEFAULT_USER,
                    'pass': DEFAULT_PASS
                },
                timeout: 240000,
                resolveWithFullResponse: true
            };
            // console.log(fileEntryID)

            // Return new promise 

            return new Promise(function (resolve, reject) {
                // Do async job
                rp(optionsGPF)
                    .then(function (response) {
                        // POST succeeded...
                        //    console.log(JSON.parse(response.body))
                        var currentGPF = JSON.parse(response.body)
                        // console.log(currentGPF.title)

                        return resolve(currentGPF.title);

                    })
                    .catch(function (err) {
                        // POST failed...
                        console.log(err);
                        //  gotonextfile();
                        return reject(err);

                    });
            })
        }

        function getFileObject(fileEntryID) {
            // var pending_files = "http://process:1234@" + URL_PAGEMAJIK_PENDING + "/group-ids/" + selectedSites + "/indd-version/" + "CS6";
            var localID = fileEntryID
            var tmpGFO = URL_FileVersion + localID;
            console.log(JSON.stringify(tmpGFO))
            var optionsGFO = {
                method: 'GET',
                uri: tmpGFO,
                auth: {
                    'user': DEFAULT_USER,
                    'pass': DEFAULT_PASS
                },
                timeout: 240000,
                resolveWithFullResponse: true
            };
            // console.log(fileEntryID)

            // Return new promise 

            return new Promise(function (resolve, reject) {
                // Do async job
                rp(optionsGFO)
                    .then(function (response) {
                        // POST succeeded...
                        //   console.log(JSON.parse(response.body))
                        var currentGFO = JSON.parse(response.body)

                        return resolve(currentGFO);

                    })
                    .catch(function (err) {
                        // POST failed...
                        console.log(err);
                        gotonextfile();
                        return reject(err);

                    });
            })
        }

        function cancel_checkout_download(fileEntryID, fileRepFolderId) {
            var tmpCCD = URL_cancelCheckout_download + fileEntryID + "/group-id/" + fileRepFolderId +
                "/status/In%20Progress/option/1";
            console.log(JSON.stringify(tmpCCD))
            var optionsCCD = {
                method: 'POST',
                uri: tmpCCD,
                auth: {
                    'user': DEFAULT_USER,
                    'pass': DEFAULT_PASS
                },
                timeout: 240000,
                resolveWithFullResponse: true
            };
            //  console.log(fileEntryID)

            // Return new promise 

            return new Promise(function (resolve, reject) {
                // Do async job
                rp(optionsCCD)
                    .then(function (response) {
                        // POST succeeded...
                        //   console.log(JSON.parse(response.body))
                        var currentCCD = JSON.parse(response.body)
                        return resolve(currentCCD);

                    })
                    .catch(function (err) {
                        // POST failed...
                        console.log(err)
                        // cancel_checkout_download(fileEntryID, fileRepFolderId)
                        sendNotification(companyID, fileRepFolderId, ezTypeUserID,
                            "",
                            "", ezTypeUserID, filename + " " + display +
                            "Unexpected Error. Kindly run the file again ", false,
                            statusfileuserID);
                        gotonextfile(); // need to work on it - File checked in by me, but i don't have download path ?? coz i missed my window, now no file
                        return reject(err);
                    });
            })
        }


        function getAllFolderID(fileEntryID, fileRepFolderId) {
            var tmpGAF = URL_cancelCheckout_download + fileEntryID + "/group-id/" + fileRepFolderId +
                "/status/In%20Progress/option/2";
            console.log(JSON.stringify(tmpGAF))
            var optionsGAF = {
                method: 'POST',
                uri: tmpGAF,
                auth: {
                    'user': DEFAULT_USER,
                    'pass': DEFAULT_PASS
                },
                timeout: 240000,
                resolveWithFullResponse: true
            };
            // console.log(fileEntryID)

            // Return new promise 

            return new Promise(function (resolve, reject) {
                // Do async job
                rp(optionsGAF)
                    .then(function (response) {
                        // POST succeeded...
                        //   console.log(JSON.parse(response.body))
                        var currentGAF = JSON.parse(response.body)
                        return resolve(currentGAF);

                    })
                    .catch(function (err) {
                        // POST failed...
                        console.log(err)
                        retry++;
                        if (retry < 2) {
                            getAllFolderID(fileEntryID, fileRepFolderId)
                        }
                        if (retry == 2) {
                            sendNotification(companyID, fileRepFolderId, ezTypeUserID,
                                "",
                                "", ezTypeUserID, filename + " " + display +
                                " Error while preparing to process the file - Code PMGAFI.", false,
                                statusfileuserID);
                            gotonextfile();
                            return reject(err);
                        }

                    });
            })
        }



        function getAllFolderContents(ID, gGroupID, zipName) {
            var tmpGAFC = URL_getAllFiles + ID + "/group-id/" + gGroupID;
            console.log(JSON.stringify(tmpGAFC))
            var optionsGAFC = {
                method: 'POST',
                uri: tmpGAFC,
                auth: {
                    'user': DEFAULT_USER,
                    'pass': DEFAULT_PASS
                },
                timeout: 600000,
                resolveWithFullResponse: true
            };
            // console.log(fileEntryID)

            // Return new promise 

            return new Promise(function (resolve, reject) {
                // Do async job
                rp(optionsGAFC)
                    .then(function (response) {
                        // POST succeeded...
                        console.log(JSON.parse(response.body))
                        var currentGAFC = JSON.parse(response.body)

                        console.log(SITE_URL + currentGAFC)
                        rp.get({
                                uri: SITE_URL + currentGAFC,
                                auth: {
                                    'user': DEFAULT_USER,
                                    'pass': DEFAULT_PASS
                                }
                            }).pipe(fs.createWriteStream(os.homedir() + "/PageMajik/" + zipName))
                            .on(
                                'finish',
                                function (line) {
                                    console.log("Finished Parsing " + zipName);
                                    return resolve();
                                });

                        // fs.createReadStream(os.homedir() + "/PageMajik/myzip.zip").pipe(unzip.Extract({ path: scriptsPath }));

                        console.log("Done")
                        // return resolve();

                    })
                    .catch(function (err) {
                        // POST failed...
                        console.log(err);
                        console.log("Downloading " + zipName + " failed. Retry count " + retry)
                        retry++;
                        if (retry < 2) {
                            // getAllFolderID(fileEntryID)
                            getAllFolderContents(ID, gGroupID, zipName)
                        } else {
                            sendNotification(companyID, fileRepFolderId, ezTypeUserID,
                                "",
                                "", ezTypeUserID, filename + " " + display +
                                " Error while preparing to process the file - Code PMGAFC.", false,
                                statusfileuserID);
                            gotonextfile();
                        }
                        return reject(err);
                    });
            })
        }




        function runIndesignScript(scriptsPath) {
            EXT_PATH = localStorage.getItem('EXT_PATH')
            EXT_PATH = EXT_PATH.replace(/ /g, "\\ ")
            //   scriptName = scriptName.replace(/ /g, "\\ ")
            //EXT_PATH = EXT_PATH.replace(/\\/g, '/');
            // EXT_PATH = EXT_PATH.replace(/\s/g, '\\ ');
            /*    console.log("\"" + EXT_PATH + "\" -run \"" + scriptName + "\"")
               cmd.get(
                   "\"" + EXT_PATH + "\" -run \"" + scriptName + "\"",
                   function (err, data, stderr) {
                       console.log('the current working dir is : ', data)
                       return new Promise(function (resolve, reject) {
                           if (err == null) {
                               //console.log(stderr)
                               return resolve(stderr);
                           } else {
                               //console.log(err)
                               return reject(err);
                           }
                       });
                   }) */

            var container = $('#menu1');
            $(container).append("<div class='content_list_right'>" +
                "<span>" + "Indesign process started ." + "</span>" +
                "</div>");

            var error
            var child = exec("./indd.sh", {
                    cwd: scriptsPath
                },
                function (error, stdout, stderr) {
                    //console.log('stdout: ' + stdout);
                    // console.log('stderr: ' + stderr);
                    if (error !== null) {
                        // console.log('exec error: ' + error);
                    }
                });
            child.stdout.on('data', function (data) {
                //pendingfiles();
                console.log('stdout: ' + data)
            })
            child.stderr.on('data', function (data) {
                //pendingfiles();
                console.log('stderr: ' + data);
                error = data;
            })
            /* child.on("close", function () {
                if(error.match("damaged and cannot be recovered")){
                    fse.emptyDir(scriptsPath);
                    javascriptContent = '';
                    startpen();
                }
                if(error.match("got an error: open (-1708)")){
                    runIndesignScript(scriptName, scriptsPath);
                }
            }); */
        }


        async function addorupdatefile(fileRepFolderId, fileFolderId, completedFN, completedfilepath,
            companyID,
            fileuserID, type) {
            console.log(completedfilepath)
            console.log(fileFolderId);


            var container = $('#menu1');
            $(container).append("<div class='content_list_right'>" +
                "<span>" + "Uploading file " + completedFN + "</span>" +
                "</div>");

            var mimeType

            if (type == "pdf") {
                mimeType = "application/vnd.adobe.indesign-idml-package";
            }
            if (type == "indd") {
                mimeType = "application/vnd.adobe.indesign-idml-package";
            }
            if (type == "idml") {
                mimeType = "application/vnd.adobe.indesign-idml-package";
            }


            var mimeType = "application/vnd.adobe.indesign-idml-package";
            var descripton = "-description"
            var changelog = "-change-log"
            var tmpAOUF = SITE_URL + "/api/jsonws/Dazzle-portlet.pagemajik/add-or-update" //repository-id" + fileRepFolderId + "/folder-id/" +
            //   fileFolderId + "/folder-id/" +fileFolderId + "/source-file-name/" + completedFN + "/" + memetype + "/title/" + completedFN + "/" +
            //    descripton + "/" + changelog;
            console.log(JSON.stringify(tmpAOUF))
            var optionsAOUF = {
                method: 'POST',
                url: tmpAOUF,
                auth: {
                    'user': DEFAULT_USER,
                    'pass': DEFAULT_PASS
                },
                //timeout: 30000,
                formData: {
                    repositoryId: fileRepFolderId,
                    folderId: fileFolderId,
                    sourceFileName: completedFN,
                    mimeType: mimeType,
                    title: completedFN,
                    description: "",
                    changeLog: "",
                    file: fs.createReadStream(completedfilepath)
                },
                // json: true
                // resolveWithFullResponse: true
            };
            // console.log(fileEntryID)

            // Return new promise 

            return new Promise(function (resolve, reject) {
                // Do async job
                rp(optionsAOUF)
                    .then(function (response) {
                        // POST succeeded...
                        //   console.log(JSON.parse(response.body))
                        //var currentCFEBN = JSON.parse(response.body)
                        console.log(response)
                        if (response.match("exception")) {
                           // gotonextfile();
                            $(container).append("<div class='content_list_right'>" +
                                "<span>" + "Error while Uploading file " + completedFN + "</span>" +
                                "</div>");
                            sendNotification(companyID, fileRepFolderId, ezTypeUserID,
                                "",
                                "", ezTypeUserID, filename + " " + display +
                                " Error while uploading the file - " + completedFN + " " + type + " .",
                                false, statusfileuserID
                            );
                            setTimeout(gotonextfile,3000)
                            return reject(err)
                        } else {
                            var container = $('#menu1');
                            $(container).append("<div class='content_list_right'>" +
                                "<span>" + "Uploaded file " + completedFN + "</span>" +
                                "</div>");
                            return resolve(response);
                        }


                    })
                    .catch(function (err) {
                        // POST failed...
                        console.log(err)
                        // getAllFolderID(fileEntryID)
                        sendNotification(companyID, fileRepFolderId, ezTypeUserID,
                            "",
                            "", ezTypeUserID, filename + " " + display +
                            " Error while uploading the file - " + completedFN + " " + type + " .",
                            false, statusfileuserID
                        );
                        //gotonextfile();
                        return reject(err);
                    });
            })
        }

        /*   function addFileEntry(fileRepFolderId, fileFolderId, completedFN, completedfilepath, companyID, fileuserID) {

              var memetype = "-meme-type";
              var descripton = "-description"
              var changelog = "-change-log"
              var tmpAFE = SITE_URL + "/api/jsonws/dlapp/add-file-entry/repository-id/" + fileRepFolderId + "/folder-id/" +
                  fileFolderId + "/source-file-name/" + completedFN + "/" + memetype + "/title/" + completedFN + "/" +
                  descripton + "/" + changelog;
              console.log(JSON.stringify(tmpAFE))
              var optionsAFE = {
                  method: 'POST',
                  uri: tmpAFE,
                  auth: {
                      'user': DEFAULT_USER,
                      'pass': DEFAULT_PASS
                  },
                  timeout: 50000,
                  formData: {
                      file: fs.createReadStream(completedfilepath)
                  },
                  //resolveWithFullResponse: true
              };
              // console.log(fileEntryID)

              // Return new promise 

              return new Promise(function (resolve, reject) {
                  // Do async job
                  rp(optionsAFE)
                      .then(function (response) {
                          // POST succeeded...
                          //   console.log(JSON.parse(response.body))
                          //var currentCFEBN = JSON.parse(response.body)
                          console.log(response)
                          return resolve(response);

                      })
                      .catch(function (err) {
                          // POST failed...
                          console.log(err)
                          // getAllFolderID(fileEntryID)
                          return reject(err);
                      });
              })



          } */



        async function getServerPathSync(contents, fileRepFolderId) {
            var tmpGSP = SITE_URL + "/api/jsonws/RSync-Portlet-portlet.rsync/get-folder-files/folder-ids/" + contents +
                "/grp-id/" + fileRepFolderId;
            console.log(JSON.stringify(tmpGSP))
            var optionsGSP = {
                method: 'GET',
                uri: tmpGSP,
                auth: {
                    'user': DEFAULT_USER,
                    'pass': DEFAULT_PASS
                },
                timeout: 600000,
                resolveWithFullResponse: true
            };
            //  console.log(fileEntryID)

            // Return new promise 

            return new Promise(function (resolve, reject) {
                // Do async job
                rp(optionsGSP)
                    .then(function (response) {
                        // POST succeeded...
                        console.log(JSON.parse(response.body))
                        var currentGSP = JSON.parse(response.body)
                        return resolve(currentGSP);

                    })
                    .catch(function (err) {
                        // POST failed...
                        console.log(err)
                        gotonextfile();
                        // cancel_checkout_download(fileEntryID, fileRepFolderId)
                        return reject(err);
                    });
            })

        }





        function rsyncFetch(filepath, destination, key, instancelogin) {
            var filepath = filepath + "/"
            var destination = destination
            var key = key
            var hostname = instancelogin
            var okay = true;
            return new Promise(function (resolve, reject) {

                //	var OS = OS

                // process1.env.PATH = "C:/windows/system32";
                // console.log(process1.env.PATH)
                // console.log(supportPath)
                /*  if (!fs.existsSync(os.homedir() + "/supportPath")) {
                     fs.mkdirSync(os.homedir() + "/supportPath");
                 } */

                //Example

                //    var key = "c:/Work/Rsync/Rsync/uploadingserver.pem"

                //online ubuntu@ec2-34-232-189-147.compute-1.amazonaws.com

                // net ubuntu@ec2-34-230-193-170.compute-1.amazonaws.com:

                //  var hostname = "ubuntu@ec2-54-237-212-163.compute-1.amazonaws.com"

                //test server info ubuntu@ec2-35-169-174-159.compute-1.amazonaws.com:

                //  var filepath = "/opt/tmp"

                //   var destination = "c:/Work/Rsync/Rsync/"
                var patt = /([\s])/g;
                key = os.homedir() + "/pagemajik-com-net.pem"
                if (SITE_URL.match(".online")) {
                    hostname = "ubuntu@ec2-34-232-189-147.compute-1.amazonaws.com:";
                }
                if (SITE_URL.match(".net")) {
                    hostname = "ubuntu@ec2-34-230-193-170.compute-1.amazonaws.com:";
                }
                if (SITE_URL.match(".info")) {
                    hostname = "ubuntu@ec2-35-169-174-159.compute-1.amazonaws.com:";
                }
                //    key = key.replace(patt, '\\$1');

                console.log(os.homedir() + destination)
                var dataf = [];

                //sample command
                //child = exec("rsync -Pav -e \"ssh -i "+key+"\" "+hostname+":"+filepath+ " "+destination)
                //rsync -avre "ssh -i uploadingserver.pem" ubuntu@ec2-54-80-249-39.compute-1.amazonaws.com:/opt/tmp /Users/rd/Desktop/Subash/Temp/

                var child = exec("rsync --inplace -avrue \"ssh -o StrictHostKeyChecking=no -i \'" + key +
                    "\'\" " + "\"" +
                    hostname +
                    "" + filepath +
                    "\"" +
                    " .", {
                        cwd: destination
                    },
                    function (error, stdout, stderr) {
                        console.log('stdout: ' + stdout);
                        console.log('stderr: ' + stderr);
                        if (error !== null) {
                            console.log('exec error: ' + error);
                        }
                    });
                child.stdout.on('data', function (data) {
                    //pendingfiles();
                    console.log(data)
                    dataf.push(data);
                })

                child.stderr.on('data', function (data) {
                    //pendingfiles();
                    console.log(data)


                    if (retry < 2) {
                        if (data.match("spawn")) {
                            var okay = false;
                            rsyncFetch(serverPath,
                                supportPath, "", "")
                            retry++
                        }
                    } else {
                        var container = $('#menu1');
                        $(container).append("<div class='content_list_right'>" +
                            "<span>" + "Rsync copy failed ." + "</span>" +
                            "</div>");
                    }


                })
                child.on("close", async function () {

                    // Do async job

                    var container = $('#menu1');
                    $(container).append("<div class='content_list_right'>" +
                        "<span>" + "Rsync process completed ." + "</span>" +
                        "</div>");

                    console.log(scriptsPath)


                    if (okay) {
                        fse.ensureDirSync(destination + 'Fonts');
                        fse.ensureDirSync(destination + 'Art');

                        try {
                            fse.move(destination + "Fonts/", destination + "Document fonts", {
                                overwrite: true
                            }, err => {
                                if (err) return console.error(err)

                                console.log('success!')
                            })
                        } catch (error) {

                        }


                        try {
                            fse.move(destination + "Art/", destination + "Links", {
                                overwrite: true
                            }, err => {
                                if (err) return console.error(err)

                                console.log('success!')
                            })
                        } catch (error) {

                        }

                        fse.ensureDirSync(destination + "Print Preset");
                        fs.readdirSync(destination + "Print Preset").forEach(file => {
                            console.log(file);
                            if (file !== presetFileName) {
                                fs.unlink(destination + "Print Preset/" + file)
                            }

                        })

                        //   copydir.sync(destination + "PageMajik", "/Documents/Adobe\ Scripts/");

                        var i = 1
                        //  console.log("Copying scripts one")
                        //    await  copydir(destination + "PageMajik/*", os.homedir()+"/Documents/Adobe\ Scripts/")
                        //   console.log("copying scripts two")
                        //      await  copydir(destination + "Adobe\ Scripts/*", os.homedir()+"/Documents/Adobe\ Scripts/")

                        // copydir.sync(destination + "PageMajik", "/Documents/Adobe\ Scripts/");

                        fse.copy(destination + "PageMajik", os.homedir() + "/Documents/Adobe Scripts/" + fileEntryID,
                            function (err) {
                                if (err) {
                                    console.error(err);
                                } else {
                                    console.log("success!");
                                    fse.copy(destination + "Adobe Scripts", os.homedir() +
                                        "/Documents/Adobe Scripts/" + fileEntryID,
                                        function (err) {
                                            if (err) {
                                                console.error(err);
                                            } else {
                                                console.log("success!");
                                                return resolve("done");
                                            }
                                        });
                                }
                            }); //copies directory, even if it has subdirectories or file

                        heimdall = true;
                        localStorage.setItem("heimdall", "true")

                    }
                })

            })
        }

        async function copydir(src, dest) {
            //    mkdir(dest);
            var child = exec("cp -rf " + src + " " + "dest",
                function (error, stdout, stderr) {
                    console.log('stdout: ' + stdout);
                    console.log('stderr: ' + stderr);
                    if (error !== null) {
                        console.log('exec error: ' + error);
                    }
                });
            child.stdout.on('data', function (data) {
                //pendingfiles();
                console.log(data)
                dataf.push(data);
            })

            child.stderr.on('data', function (data) {
                //pendingfiles();
                console.log(data)
                return reject("error")
            })
            child.on("close", async function () {
                return resolve("done");
            })

        };

        function gotonextfile() {
            currentrun = false;
            console.log("failed...")
            console.log(filename);
            addFileToFailed(filename, filepathbroken[1], filepathbroken[5], process);
            //    FailedFiles.push(localStorage.getItem("FailedFiles"));
            //   FailedFiles.push(filename)
            //   localStorage.setItem("FailedFiles", FailedFiles);

            clearTimeout(
                timer);
            startpenstuck();
            return;
        }


        function sendNotification(companyID, groupID, userID, type, timeStamp, delivered, payload, archived,
            receiver) {
            console.log(companyID)
            console.log(groupID);
            console.log(userID);
            console.log(type);
            console.log(timeStamp);
            console.log(delivered);
            console.log(payload);
            console.log(archived);
            console.log(receiver);

            var tmpSN = SITE_URL + "/api/jsonws/Dazzle-portlet.notify/create-notification/company-id/" + companyID +
                "/group-id/0/user-id/" + receiver + "/-type_/time-stamp/0/delivery-by/" + userID +
                "/delivered/0/payload/" + payload + "/archived/false/receiver/" + receiver
            //repository-id" + fileRepFolderId + "/folder-id/" +
            //   fileFolderId + "/folder-id/" +fileFolderId + "/source-file-name/" + completedFN + "/" + memetype + "/title/" + completedFN + "/" +
            //    descripton + "/" + changelog;
            console.log(JSON.stringify(tmpSN))
            var optionstmpSN = {
                method: 'POST',
                url: tmpSN,
                auth: {
                    'user': DEFAULT_USER,
                    'pass': DEFAULT_PASS
                },
                //timeout: 30000,
                /* formData: {
                    companyId: companyId,
                    groupId: "0",
                    userId: receiver,
                    type_: type,
                    timeStamp:"0",
                    deliveryBy: userID,
                    delivered: "0",
                    payload: payload,
                    archived: archived,
                    receiver: receiver
                }, */
                // json: true
                resolveWithFullResponse: true
            };
            // console.log(fileEntryID)

            // Return new promise 

            return new Promise(function (resolve, reject) {
                // Do async job
                rp(optionstmpSN)
                    .then(function (response) {
                        // POST succeeded...
                        console.log(JSON.parse(response.body))
                        var currentSN = JSON.parse(response.body)
                        //  console.log(response)
                        return resolve(currentSN);

                    })
                    .catch(function (err) {
                        // POST failed...
                        console.log(err)
                        // getAllFolderID(fileEntryID)
                        //gotonextfile();
                        return reject(err);
                    });
            })
        }


        function getUserIdByScreenName(companyID, userScreenName) {
            var tmpGUID = SITE_URL +
                "/api/jsonws/user/get-user-id-by-screen-name/company-id/" + companyID + "/screen-name/" +
                userScreenName;
            console.log(JSON.stringify(tmpGUID))
            var optionsGUID = {
                method: 'GET',
                uri: tmpGUID,
                auth: {
                    'user': DEFAULT_USER,
                    'pass': DEFAULT_PASS
                },
                timeout: 120000,
                resolveWithFullResponse: true
            };
            //  console.log(fileEntryID)

            // Return new promise 

            return new Promise(function (resolve, reject) {
                // Do async job
                rp(optionsGUID)
                    .then(function (response) {
                        // POST succeeded...
                        console.log(response)
                        console.log(JSON.parse(response.body))
                        var currentGSP = JSON.parse(response.body)
                        return resolve(currentGSP);

                    })
                    .catch(function (err) {
                        // POST failed...
                        console.log(err)
                        // gotonextfile();
                        // cancel_checkout_download(fileEntryID, fileRepFolderId)
                        return reject(err);
                    });
            })
        }


        function getBookmapPageNumber(BookMapID, title) {
            var patt1 = /\.[0-9a-z]+$/i;
            var twe = title.replace(patt1, "")
            var tmpGBM = SITE_URL +
                "/api/jsonws/Dazzle-portlet.pagemajik/get-book-map-json/file-entry-id/" + BookMapID +
                "/chapter-title/" + twe
            console.log(JSON.stringify(tmpGBM))
            var optionsGBM = {
                method: 'GET',
                uri: tmpGBM,
                auth: {
                    'user': DEFAULT_USER,
                    'pass': DEFAULT_PASS
                },
                timeout: 120000,
                resolveWithFullResponse: true
            };

            //  console.log(fileEntryID)

            // Return new promise 

            return new Promise(function (resolve, reject) {
                // Do async job
                rp(optionsGBM)
                    .then(function (response) {
                        // POST succeeded...
                        //   console.log(response)
                        console.log(JSON.parse(response.body))
                        var currentGBM = JSON.parse(response.body)
                        return resolve(currentGBM);

                    })
                    .catch(function (err) {
                        // POST failed...
                        console.log(err)
                        gotonextfile();
                        //  break;
                        // cancel_checkout_download(fileEntryID, fileRepFolderId)
                        return reject(err);
                    });
            })

        }

        function putBookmapPageNumber(fileEntryId, title, PGnum) {
            var patt1 = /\.[0-9a-z]+$/i;
            var twe = title.replace(patt1, "")
            var tmpPBM = SITE_URL +
                "/api/jsonws/Dazzle-portlet.pagemajik/update-book-map-json/file-entry-id/" + fileEntryId +
                "/chapter-title/" + twe + "/page-count/" + PGnum
            console.log(JSON.stringify(tmpPBM))
            var optionsPBM = {
                method: 'GET',
                uri: tmpPBM,
                auth: {
                    'user': DEFAULT_USER,
                    'pass': DEFAULT_PASS
                },
                timeout: 120000,
                resolveWithFullResponse: true
            };
            //  console.log(fileEntryID)

            // Return new promise 

            return new Promise(function (resolve, reject) {
                // Do async job
                rp(optionsPBM)
                    .then(function (response) {
                        // POST succeeded...
                        //   console.log(response)
                        console.log(JSON.parse(response.body))
                        var currentPBM = JSON.parse(response.body)
                        return resolve(currentPBM);

                    })
                    .catch(function (err) {
                        // POST failed...
                        console.log(err)
                        gotonextfile();
                        //   break;
                        // cancel_checkout_download(fileEntryID, fileRepFolderId)
                        return reject(err);
                    });
            })
        }

        function cancel_checkout(fileEntryId) {
            var tmpCC = URL_cancelCheckout + fileEntryID;
            console.log(JSON.stringify(tmpCC))
            var optionsCC = {
                method: 'POST',
                uri: tmpCC,
                auth: {
                    'user': DEFAULT_USER,
                    'pass': DEFAULT_PASS
                },
                timeout: 240000,
                resolveWithFullResponse: true
            };
            //  console.log(fileEntryID)

            // Return new promise

            return new Promise(function (resolve, reject) {
                // Do async job
                rp(optionsCC)
                    .then(function (response) {
                        // POST succeeded...
                        //   console.log(JSON.parse(response.body))
                        if (response.body.match("exception")) {
                            gotonextfile();
                            return reject("exception")
                        }
                        var currentCC = JSON.parse(response.body)
                        return resolve(currentCC);

                    })
                    .catch(function (err) {
                        // POST failed...
                        console.log(err)
                        sendNotification(companyID, fileRepFolderId, ezTypeUserID,
                            "",
                            "", ezTypeUserID, filename + " " + display +
                            "Cancel checkout failed. But the file is completed. Kindly cancel checkout manually if it is not Locked",
                            false, statusfileuserID);
                        gotonextfile(); //Need to work on error - process completed but no checkout??
                        return reject(err);
                    });
            })
        }

        function addFileToInProgress(filename) {
            var container = $('#menu1');
            //var inputs = container.find('div');
            var id = filename;
            $(container).empty();

            /* $('<div>', {
                class: "content_header content_list_left",
            }).appendTo(container) */

            $(container).append("<div class='content_list_right'>" +
                "<span>" + process + " running for " + filename + "</span>" +
                "</div>")
        }



        function addFileToFailed(filename, selectedsite, bookname, process) {


            var container = $('#menu1');
            $(container).empty();
            var container1 = $('#menu3')
            $(container1).append("<div class='content_list_right'>" +
                "<span>" + filename + "</span>" +
                "</div>")
        }


            $('#box-1').click(function (event) {
                if (this.checked) {
                    // Iterate each checkbox
                    $(':checkbox').each(function () {
                        this.checked = true;
                    });
                } else {
                    $(':checkbox').each(function () {
                        this.checked = false;
                    });
                }
            });
    </script>
</body>

</html>